# SSH终端关键问题及修复方案

## 问题总结

### 1. 终端卡死问题
**现象**：
- 执行约10条命令后终端无响应
- 不接受任何输入
- 必须刷新页面才能恢复

**根本原因**：
- WebSocket写入channel缓冲区满（256个消息）
- 写入阻塞导致整个处理链停止
- 原设计在channel满时直接丢弃消息

### 2. shutdown命令未被拦截
**现象**：
- `rm` 命令正确拦截
- `shutdown` 命令可以执行
- 命令过滤不一致

**可能原因**：
1. 命令缓冲区可能包含不可见字符
2. 命令匹配逻辑问题
3. 过滤规则配置问题

## 已实施的修复

### 1. 增强写入通道容量和流控制
```go
// 增加缓冲区到1024
wsConn.writeChan = make(chan interface{}, 1024)

// 实现智能消息处理
- 重要消息（输入响应等）：等待发送
- 非重要消息（大量输出）：满时丢弃
- 添加写入超时避免永久阻塞
- 定期监控channel状态
```

### 2. 改进命令提取逻辑
```go
// 清理命令字符串
command = strings.TrimSpace(command)
// 只取第一行
if idx := strings.IndexAny(command, "\r\n"); idx >= 0 {
    command = command[:idx]
}
```

### 3. 增强调试日志
- 记录输入的十六进制值
- 记录命令缓冲区内容和长度
- 监控channel积压情况

## 需要进一步验证的事项

### 1. 命令过滤规则
需要检查数据库中的过滤规则：
```sql
-- 检查命令过滤规则
SELECT * FROM command_filters WHERE command LIKE '%shutdown%';
SELECT * FROM command_groups WHERE name LIKE '%危险%';
```

### 2. 性能监控
- 观察channel积压情况
- 监控消息丢弃率
- 检查内存使用

### 3. 压力测试
- 大量输出场景（如 `find /`）
- 快速命令执行
- 长时间运行稳定性

## 后续优化建议

### 1. 实现真正的背压机制
- 当输出过快时，暂停SSH读取
- 实现流量控制协议
- 考虑使用环形缓冲区

### 2. 改进命令过滤
- 在客户端预检测命令
- 使用更精确的命令解析
- 实现命令别名检测

### 3. 优化消息传输
- 实现消息批处理
- 压缩大量输出
- 使用二进制协议

## 测试建议

1. **基础功能测试**
   ```bash
   # 测试命令过滤
   shutdown
   rm -rf /
   reboot
   
   # 测试大量输出
   find / -name "*.log"
   cat /var/log/messages
   
   # 测试快速输入
   for i in {1..20}; do echo $i; done
   ```

2. **压力测试**
   - 持续运行30分钟
   - 监控后端日志
   - 检查channel状态

3. **兼容性测试**
   - vim编辑器
   - top/htop监控
   - 中文输入

## 部署检查清单

- [ ] 后端重新编译
- [ ] 检查数据库过滤规则
- [ ] 监控日志输出
- [ ] 准备回滚方案
- [ ] 通知相关人员