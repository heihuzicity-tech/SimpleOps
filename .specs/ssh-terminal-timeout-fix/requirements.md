# SSH终端超时修复 - 需求规范

## 概述
修复SSH终端因WebSocket超时配置不当导致的闲置断开问题，优化终端滚动性能，统一超时管理机制。

## 用户故事
作为一个SSH终端使用者，我希望终端连接能够根据我选择的超时策略（如30分钟、1小时或无限制）稳定保持连接，并且在大量输出时滚动流畅，以便我能够高效地进行远程操作。

## 接受标准 (EARS格式)
1. WHEN 用户打开SSH终端并保持闲置状态，系统 SHALL 保持连接直到达到用户选择的会话超时时间
2. IF WebSocket连接存在网络问题，THEN 系统应通过心跳机制检测并提示用户
3. WHILE 终端接收大量输出数据时，用户 SHALL 能够流畅地滚动查看历史内容
4. WHEN 会话达到用户设置的超时时间，系统 SHALL 按照SessionTimeoutService的配置正确关闭连接
5. IF 用户选择"无限制"超时策略，THEN 系统 SHALL 保持连接直到用户主动断开或网络故障

## 功能需求
### 1. WebSocket超时修复
- 删除ssh_controller.go中的SetReadDeadline硬性超时设置
- 移除60秒的WebSocket读取超时限制
- 保留心跳机制仅用于连接健康检查

### 2. 业务层超时保持
- 确保SessionTimeoutService根据用户选择的超时时间正常工作
- 不受WebSocket层超时影响
- 支持以下超时策略：
  - 固定超时（fixed）：从会话创建开始计时
  - 空闲踢出（idle_kick）：从最后活动时间开始计时
  - 无限制（unlimited）：永不超时
- 支持用户动态选择超时时长（如5分钟、30分钟、1小时、2小时等）

### 3. 终端性能优化
- 优化xterm.js的滚动缓冲区配置
- 减少scrollback行数以提升性能
- 优化Canvas渲染器设置

## 非功能需求
### 性能需求
- 终端滚动响应时间 < 100ms
- 大量输出时CPU占用率不超过50%
- 内存使用稳定，无泄漏

### 可靠性需求
- 心跳检测间隔30秒，3次失败后断开
- 网络恢复后能自动重连
- 超时机制准确可靠

## 约束条件
### 技术约束
- 必须兼容现有的WebSocket实现
- 不能影响其他SSH功能
- 保持向后兼容性

### 业务约束
- 修改必须最小化，降低风险
- 不改变用户操作习惯
- 保持现有的安全策略

## 风险评估
### 技术风险
- 移除ReadDeadline可能导致僵尸连接 - 概率：低，影响：中
  - 缓解策略：通过业务层超时和心跳机制管理

### 兼容性风险
- 修改可能影响现有连接管理 - 概率：低，影响：高
  - 缓解策略：充分测试各种场景

## 验收测试场景
1. 设置30分钟固定超时，终端闲置35分钟，验证30分钟时正确断开
2. 设置1小时固定超时，终端闲置50分钟，验证连接保持正常
3. 设置"无限制"策略，终端闲置2小时，验证连接仍保持
4. 设置10分钟空闲踢出，操作后闲置15分钟，验证正确断开
5. 大量输出时滚动，验证无卡顿
6. 网络断开恢复，验证重连机制
7. 多终端并发不同超时设置，验证各自独立工作