# 修复操作审计重复记录 - 需求规格说明

## 概述
修复SSH会话创建过程中操作审计系统产生重复记录的问题，并完善审计记录的资源ID字段，确保审计记录的准确性和完整性。

## 用户场景
作为系统管理员，我希望操作审计记录准确反映用户的实际操作，避免重复记录造成的数据冗余和分析困扰。

## 验收标准（EARS格式）
1. WHEN 用户创建SSH会话时，系统SHALL只产生一条操作审计记录
2. IF SSH会话创建成功，THEN 操作审计记录SHALL包含完整的会话ID信息
3. WHILE 查看操作审计详情时，资源ID字段SHALL显示对应的会话ID而不是"-"

## 功能需求

### 核心问题修复
- **问题1**: 消除重复的操作审计记录
  - 当前：创建SSH会话产生4条记录（2条test-connection + 2条sessions）
  - 期望：创建SSH会话只产生1条记录

- **问题2**: 修复资源ID字段缺失和SessionID完整性
  - 当前：操作审计详情显示"资源ID: -"，缺少完整会话信息
  - 期望：显示数字ResourceID和完整SessionID（如：ssh-1753150388-6621976715634441153）
  - 设计：新增SessionID字段，保持ResourceID数字格式的向后兼容性

### 具体场景
#### 场景1：SSH会话创建
**输入条件**: 用户通过前端创建SSH连接会话
**预期结果**: 
- 操作审计表中仅新增1条记录
- 记录包含操作类型、资源类型、请求方法、状态码、IP地址、耗时等完整信息
- ResourceID字段显示数字ID（如：1753150388）
- SessionID字段显示完整会话标识符（如：ssh-1753150388-6621976715634441153）

#### 场景2：审计记录查询
**输入条件**: 管理员查看操作审计详情
**预期结果**:
- 详情页正确显示数字ResourceID和完整SessionID
- 可以通过SessionID与会话审计、录屏审计记录建立精确关联关系
- 保持与现有系统的向后兼容性

## 非功能需求

### 性能需求
- 修复后的审计记录响应时间：≤ 50ms
- 不应影响现有SSH连接的建立速度

### 安全需求
- 审计记录不能丢失任何关键操作信息
- 保持审计日志的完整性和时序性
- 确保资源ID不暴露敏感信息

### 兼容性需求
- 修复不应影响现有的审计查询功能
- 保持与前端审计页面的接口兼容性

## 约束条件

### 技术约束
- 必须在现有Go后端架构基础上修改
- 不能破坏现有的中间件和服务层结构
- 需要保持MySQL数据库表结构的向后兼容

### 业务约束
- 修复过程中不能影响生产环境的正常使用
- 需要保留历史审计数据的完整性
- 修复后需要与现有会话审计、录屏审计保持一致性

## 风险评估

### 技术风险
- **审计记录丢失** - 概率: 低, 影响: 高
- **现有功能回退** - 概率: 中, 影响: 中

### 缓解策略
- **审计记录丢失**: 在修改前进行充分的单元测试和集成测试
- **现有功能回退**: 采用渐进式修改，保持向后兼容，充分的回归测试

## 验收测试场景

### 测试场景1：单次SSH会话创建
1. 用户登录系统
2. 选择主机创建SSH连接
3. 验证操作审计表中仅产生1条记录
4. 验证记录包含正确的会话ID

### 测试场景2：并发SSH会话创建
1. 多个用户同时创建SSH连接
2. 验证每个会话仅产生1条审计记录
3. 验证会话ID唯一性和正确性

### 测试场景3：审计记录关联性
1. 创建SSH会话
2. 查看操作审计详情
3. 验证会话ID与会话审计中的记录匹配
4. 验证可以正确关联到录屏审计

## 完成标准
- [ ] SSH会话创建时仅产生1条操作审计记录
- [ ] 操作审计详情正确显示会话ID
- [ ] 所有现有审计功能正常工作
- [ ] 通过完整的回归测试
- [ ] 代码通过review并符合项目规范