# 修复命令审计功能 - 需求规格说明

## 概述
修复堡垒机系统的命令审计功能，确保SSH会话中执行的命令能够被正确记录和审计。目前系统存在命令记录不完整或无法正常记录的问题。

## 用户故事
作为安全管理员，我希望系统能够完整记录用户在SSH会话中执行的所有命令，以便进行安全审计和合规检查。

## 验收标准（EARS格式）
1. WHEN 用户在SSH会话中执行任何命令时，系统SHALL 记录该命令到命令日志表
2. IF 命令执行完成，THEN 系统SHALL 记录命令的执行结果、退出码和执行时间
3. WHILE SSH会话活跃时，系统SHALL 能够实时捕获并记录所有命令执行信息
4. WHEN 查看命令审计日志时，系统SHALL 显示完整的命令内容、执行用户、会话ID等信息
5. WHEN 用户访问命令审计页面时，系统SHALL 显示简洁的表格布局，匹配参考设计风格
6. IF 用户需要查看命令详情，THEN 系统SHALL 在模态框中显示完整信息
7. WHEN 用户访问命令审计页面时，系统SHALL 正确调用后端API获取命令日志数据
8. IF 用户执行搜索操作，THEN 系统SHALL 通过API传递正确的搜索参数并返回匹配结果
9. WHEN 用户点击查看详情时，系统SHALL 调用详情API并在模态框中正确显示所有信息

## 功能需求
### 命令记录功能
- 实时捕获SSH会话中的命令输入
- 记录命令执行的完整信息（命令内容、用户、时间、结果等）
- 确保命令记录的完整性和准确性

### 审计查询功能
- 支持按主机、操作用户、命令内容等条件查询
- 单一搜索框配合下拉选择的查询方式
- 支持分页查看和排序
- 显示命令执行详情（包括输出结果）

### 用户界面优化
- 重新设计命令审计页面，采用更简洁的表格布局
- 参考提供的界面设计，使用紧凑的行间距和简约的视觉风格
- 移除复杂的统计卡片、警告提示
- 保持核心功能的易用性：搜索、过滤、分页、查看详情
- 不需要显示风险等级字段

### API对接需求
- 确保前端命令审计页面与后端API正确对接
- 实现命令日志列表的获取和展示
- 实现搜索功能的后端支持（按主机、操作用户、命令内容）
- 实现分页功能的正确对接
- 实现命令详情查看功能的API对接
- 确保所有数据能够正常渲染和展示

### 数据持久化
- 命令日志必须可靠存储在数据库中
- 支持配置审计日志保留期限
- 防止审计日志被非授权删除或修改

## 非功能需求
### 性能需求
- 命令记录延迟不超过100ms
- 查询响应时间不超过2秒（千万级数据量）
- 不影响SSH会话的正常使用体验

### 安全需求
- 审计日志访问需要相应权限
- 敏感命令输出应进行脱敏处理
- 审计记录应包含完整的用户身份信息

### 可靠性需求
- 命令记录成功率达到99.9%以上
- 系统故障不应导致审计数据丢失
- 支持审计数据的备份和恢复

## 约束条件
### 技术约束
- 必须兼容现有的SSH服务实现
- 使用现有的数据库模型结构
- 保持与前端组件的接口兼容性

### 业务约束
- 不能影响现有SSH会话功能
- 保持审计日志格式的一致性
- 符合安全合规要求

## 风险评估
### 技术风险
- SSH协议解析可能存在兼容性问题 - 概率：中，影响：高
- 高并发场景下的性能瓶颈 - 概率：中，影响：中
- 命令输出过大导致存储问题 - 概率：低，影响：中

### 缓解策略
- SSH协议兼容性：进行充分的测试，支持主流SSH客户端
- 性能优化：使用异步记录机制，实施适当的缓存策略
- 存储优化：对大型输出进行截断或压缩存储

## 现有问题分析
基于代码分析，发现以下潜在问题：
1. RecordCommand方法中用户名参数为空字符串，需要正确获取用户名
2. 可能存在命令捕获机制不完善的问题
3. 前端显示正常但后端可能存在数据记录问题
4. SSH会话中的命令执行信息可能未被正确传递到审计服务
5. 当前前端UI过于复杂，包含不必要的统计功能和视觉效果

## 成功标准
1. 所有SSH会话命令都能被成功记录
2. 命令审计查询功能正常工作
3. 审计数据完整准确
4. 系统性能满足要求
5. 前端UI符合参考设计的简洁风格
6. 通过所有相关测试用例