# 修复命令审计功能 - 实施任务

## 任务概览
本功能包含3个主要模块，预计需要2个工作日完成。

## 前置条件
- [ ] 开发环境已配置
- [ ] 数据库连接正常
- [ ] 前后端项目可以正常运行

## 任务列表

### 1. 前端UI重新设计（优先级：高）
- [x] 1.1 简化表格布局
  - 文件：`frontend/src/components/audit/CommandLogsTable.tsx`
  - 描述：移除统计卡片和警告组件，采用简洁的表格设计
  - 验收：界面匹配参考图片的简约风格

- [x] 1.2 调整表格列配置
  - 文件：`frontend/src/components/audit/CommandLogsTable.tsx`
  - 描述：按照参考设计调整列顺序和宽度：用户、命令、资产、账号、会话、日期时间
  - 验收：表格列符合新的设计规范，不显示风险等级

- [x] 1.3 优化搜索和过滤布局
  - 文件：`frontend/src/components/audit/CommandLogsTable.tsx`
  - 描述：实现单一搜索框设计，下拉选择搜索类型（主机/操作用户/命令内容）
  - 验收：搜索功能正常且界面简洁，移除时间过滤

- [x] 1.4 调整视觉样式
  - 文件：`frontend/src/components/audit/CommandLogsTable.tsx`
  - 描述：使用紧凑的行间距、适当的字体大小、简约的配色
  - 验收：视觉效果与参考图片一致

### 2. 后端命令记录修复（优先级：中）
- [ ] 2.1 修复SSH服务中的用户名获取问题
  - 文件：`backend/services/ssh_service.go`
  - 描述：修改RecordCommand方法，正确获取并传递用户名
  - 验收：命令记录包含正确的用户名信息

- [ ] 2.2 增强命令时间记录
  - 文件：`backend/services/ssh_service.go`
  - 描述：确保命令开始时间和结束时间被正确记录
  - 验收：命令日志包含准确的执行时间和持续时间

### 3. 命令捕获机制优化（优先级：中）
- [ ] 3.1 改进命令缓冲区管理
  - 文件：`backend/controllers/ssh_controller.go`
  - 描述：优化updateCommandBuffer方法，更准确地解析命令
  - 验收：能够正确识别和记录各种命令格式

- [ ] 3.2 完善命令执行记录触发
  - 文件：`backend/controllers/ssh_controller.go`
  - 描述：在命令执行完成时正确调用审计记录服务
  - 验收：每个执行的命令都被记录到数据库

- [ ] 3.3 处理特殊字符和编码
  - 文件：`backend/controllers/ssh_controller.go`
  - 描述：正确处理多字节字符、特殊字符和控制字符
  - 验收：中文命令和特殊字符命令能正确记录

### 4. 集成测试与验证（优先级：低）
- [ ] 4.1 测试命令记录完整性
  - 文件：手动测试
  - 描述：通过SSH会话执行各种命令，验证记录的完整性
  - 验收：所有类型的命令都能被正确记录

- [ ] 4.2 测试前端展示功能
  - 文件：手动测试
  - 描述：验证搜索、过滤、分页、查看详情等功能
  - 验收：所有前端功能正常工作

- [ ] 4.3 性能测试
  - 文件：性能测试脚本
  - 描述：测试大量命令记录时的系统性能
  - 验收：满足性能需求（记录延迟<100ms，查询<2s）

### 5. 代码优化与文档（优先级：低）
- [ ] 5.1 代码审查和优化
  - 文件：所有修改的文件
  - 描述：确保代码质量，添加必要的注释
  - 验收：代码符合项目规范

- [ ] 5.2 更新相关文档
  - 文件：API文档、用户手册
  - 描述：更新命令审计相关的文档
  - 验收：文档准确完整

### 6. API对接验证（已完成）
- [x] 6.1 确认后端API响应格式统一
  - 文件：审核 `.specs/统一后端API响应格式/` 文档
  - 描述：确认审计控制器已使用统一响应格式
  - 验收：API返回格式符合统一标准（items字段、分页信息扁平化）
  
- [x] 6.2 验证前端与后端API对接
  - 文件：`frontend/src/components/audit/CommandLogsTable.tsx`
  - 描述：前端已正确对接统一格式的API
  - 验收：命令日志列表和详情功能正常工作

## 执行指南
### 任务执行规则
1. **优先级执行**：优先完成高优先级任务（前端UI重新设计）
2. **依赖检查**：前端可以独立开发，不依赖后端修复
3. **质量标准**：每个任务必须通过验收标准
4. **问题记录**：遇到问题立即记录并寻求解决

### 完成标记
- `[x]` 已完成的任务
- `[!]` 遇到问题的任务
- `[~]` 进行中的任务

### 执行命令
- `/kiro exec 1.1` - 执行特定任务
- `/kiro next` - 执行下一个未完成的任务
- `/kiro continue` - 继续未完成的任务

## 进度跟踪
### 时间规划
- **预计开始时间**：2024-01-31
- **预计完成时间**：2024-02-01

### 完成统计
- **总任务数**：16
- **已完成**：6
- **进行中**：0
- **完成率**：37.5%

### 里程碑
- [x] 前端UI重设计完成（任务1.x）- 优先完成
- [ ] 后端功能修复完成（任务2.x和3.x）
- [ ] 测试验证完成（任务4.x）
- [ ] 项目交付完成（任务5.x）
- [x] API对接验证完成（任务6.x）

## 变更日志
- [2024-01-31] - 创建任务计划 - 基于需求和设计文档 - 影响所有任务
- [2024-01-31] - 调整任务优先级 - 前端UI重设计优先执行 - 任务顺序重新编号
- [2024-01-31] - 完成前端UI重设计 - 包括搜索框优化和表格简化 - 任务1.1-1.4已完成
- [2025-01-31] - 确认API对接完成 - 后端API响应格式已统一，前端无需修改 - 影响任务6.x

## 完成检查清单
- [ ] 所有任务已完成并通过验收标准
- [ ] 代码已提交并通过代码审查
- [ ] 所有测试用例通过
- [ ] 文档已更新
- [ ] 功能在生产环境可用