# BaseApiService架构升级 - 需求规范文档

## 概述
在完成后端API响应格式统一化后，前端仍存在大量的响应格式适配问题。目前responseAdapter.ts已包含130+行的条件判断，且凭证管理、审计日志等多个模块仍无法正常工作。需要通过引入BaseApiService架构，从根本上解决响应格式统一化问题，建立可持续的API调用架构。

## 用户故事
作为前端开发者，我希望有一个统一的API服务层来处理所有的请求和响应格式转换，这样我可以专注于业务逻辑开发，而不需要在每个模块中处理响应格式差异。

作为系统维护者，我希望API调用层架构清晰、易于扩展，这样在添加新功能或修改现有功能时，可以快速实现且不影响其他模块。

## 接受标准（EARS格式）
1. WHEN 调用任何API时，系统 SHALL 自动处理响应格式转换，返回统一的数据结构
2. IF API返回新的统一格式，THEN BaseApiService SHALL 自动转换为前端期望的格式
3. WHILE 进行API调用时，系统 SHALL 提供统一的错误处理和日志记录
4. WHEN 添加新的API模块时，开发者 SHALL 只需继承BaseApiService即可获得所有基础功能
5. IF 响应格式发生变化，THEN 只需在BaseApiService中修改一次即可影响所有模块

## 功能需求

### 核心架构要求
- 创建BaseApiService基类，封装所有通用的HTTP请求和响应处理逻辑
- 自动处理响应格式转换，支持新旧格式的智能识别
- 提供统一的错误处理机制
- 支持请求/响应拦截器的扩展
- 保持与现有Redux架构的兼容性

### 响应格式处理
- 自动识别并转换统一格式响应（items、total、page等）
- 支持嵌套的data.data结构处理
- 兼容各模块的特殊字段名（users、roles、credentials等）
- 提供类型安全的响应数据

### API Service实现要求
- 每个业务模块创建对应的ApiService类（继承BaseApiService）
- Service类保持与原API文件相同的公开接口
- 内部自动处理所有格式转换
- 支持TypeScript类型推断

### 迁移策略
- 优先迁移当前有问题的模块（凭证管理、审计日志等）
- 保持向后兼容，允许渐进式迁移
- 不影响现有功能的正常使用

## 非功能需求

### 性能需求
- 响应格式转换处理时间 < 3ms
- 不增加额外的网络请求
- 支持响应数据缓存（预留接口）

### 可维护性需求
- 代码结构清晰，遵循SOLID原则
- 充分的类型定义和注释
- 易于调试和问题定位
- 支持单元测试

### 扩展性需求
- 易于添加新的API模块
- 支持自定义请求/响应处理
- 预留中间件机制
- 支持未来功能扩展（离线支持、请求重试等）

## 约束条件

### 技术约束
- 必须使用TypeScript实现
- 兼容现有的axios实例和配置
- 保持与Redux Toolkit的集成
- 不能破坏现有的API调用

### 业务约束
- 迁移过程不能影响生产环境
- 必须保证数据的准确性
- 需要完整的测试覆盖

## 风险评估

### 技术风险
- **类型定义复杂性** - 概率：中，影响：中
  - 缓解策略：使用泛型和类型推断简化类型定义
- **迁移过程中的兼容性问题** - 概率：中，影响：高
  - 缓解策略：保持原有API接口，逐步迁移
- **性能影响** - 概率：低，影响：中
  - 缓解策略：优化转换逻辑，避免深拷贝

### 业务风险
- **功能回归** - 概率：中，影响：高
  - 缓解策略：完整的测试用例，分阶段发布

## 受影响模块清单

### 立即需要修复的模块（第一批）
1. **credentialAPI.ts** → CredentialApiService（凭证管理）
2. **auditAPI.ts** → AuditApiService（审计日志）  
3. **sshAPI.ts** → SshApiService（SSH会话管理）

### 后续迁移的模块（第二批）
4. **userAPI.ts** → UserApiService（用户管理）
5. **roleAPI.ts** → RoleApiService（角色管理）
6. **authAPI.ts** → AuthApiService（认证授权）

### 其他模块（第三批）
7. **assetAPI.ts** → AssetApiService（资产管理）
8. **workspaceAPI.ts** → WorkspaceApiService（工作空间）
9. 其他辅助模块

## 成功标准
- 所有问题模块恢复正常功能
- 移除或大幅简化responseAdapter.ts
- API调用代码减少30%以上
- 新增模块开发效率提升50%
- 零生产环境故障
- 完整的单元测试覆盖