# 统一后端API响应格式 - 需求规范文档

## 概述
本项目是对堡垒机系统进行彻底的API响应格式重构和统一。通过建立系统级的统一响应格式规范，从根本上解决格式不一致问题，为系统的长期维护和扩展奠定坚实基础。这不仅是修复当前问题，更是建立未来所有API开发的标准规范。

## 用户故事
作为前端开发者，我希望所有后端API都返回统一格式的响应数据，这样我可以使用统一的数据处理逻辑，减少代码复杂度和出错概率。

作为系统维护者，我希望API响应格式规范化，这样在添加新功能或修改现有功能时，可以快速理解和遵循既定标准。

## 接受标准（EARS格式）
1. WHEN 前端请求分页数据时，系统SHALL 返回包含 `items`、`total`、`page`、`page_size`、`total_pages` 字段的统一格式响应
2. IF API调用成功，THEN 响应SHALL 包含 `success: true` 和 `data` 字段
3. IF API调用失败，THEN 响应SHALL 包含 `success: false` 和 `error` 字段
4. WHILE 处理分页请求时，系统SHALL 自动计算 `total_pages` 值
5. WHEN 返回单个资源时，系统SHALL 将资源数据直接放在 `data` 字段中
6. IF 操作成功但无数据返回，THEN 响应SHALL 包含 `success: true` 和 `message` 字段

## 功能需求
### 统一响应格式
- 成功响应必须包含 `success: true` 标识
- 分页数据必须使用 `items` 字段存放数据数组
- 错误响应必须包含 `error` 字段说明错误原因
- 所有时间戳使用ISO 8601格式

### 响应类型规范
- **分页响应**：用于列表查询，包含分页元数据
- **单项响应**：用于单个资源查询或创建
- **操作响应**：用于无数据返回的操作（如删除）
- **错误响应**：用于所有错误情况

### 向后兼容性
- 提供响应格式转换中间件选项
- 支持API版本控制机制
- 允许渐进式迁移策略

## 非功能需求
### 性能需求
- 响应格式转换不应增加超过5ms的延迟
- 统一格式不应显著增加响应体大小

### 安全需求
- 错误响应不应暴露系统内部细节
- 敏感信息必须在响应前过滤

### 可维护性需求
- 提供清晰的响应构建辅助函数
- 所有响应格式必须有对应的TypeScript类型定义
- 必须更新API文档反映新格式

## 约束条件
### 技术约束
- 必须兼容现有的Gin框架
- 必须支持JSON格式输出
- 前端TypeScript定义必须与后端保持同步

### 业务约束
- 不能影响现有的业务逻辑
- 迁移过程不能导致服务中断
- 必须在2周内完成主要模块迁移

## 风险评估
### 技术风险
- **现有功能破坏** - 概率：高，影响：高
  - 缓解策略：完善的测试覆盖，分阶段发布
- **第三方集成影响** - 概率：中，影响：中
  - 缓解策略：提供版本控制，向后兼容选项
- **性能下降** - 概率：低，影响：中
  - 缓解策略：性能测试，优化转换逻辑

### 业务风险
- **用户体验中断** - 概率：中，影响：高
  - 缓解策略：灰度发布，快速回滚机制

## 涉及模块清单
需要统一响应格式的控制器（9个）：
1. `command_policy_controller.go` - 命令策略管理
2. `ssh_controller.go` - SSH会话管理
3. `audit_controller.go` - 审计日志
4. `monitor_controller.go` - 会话监控
5. `recording_controller.go` - 会话录像
6. `asset_controller.go` - 资产管理
7. `auth_controller.go` - 认证授权
8. `role_controller.go` - 角色管理
9. `user_controller.go` - 用户管理

## 成功标准
- 所有API端点返回格式统一
- 前端代码简化，移除特殊格式处理逻辑
- 通过所有单元测试和集成测试
- API文档更新完成
- 零生产环境事故