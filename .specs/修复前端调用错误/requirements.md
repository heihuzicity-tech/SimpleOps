# 修复前端调用错误 - 需求规格说明书

## 概述
在后端API响应格式统一化改造后，前端存在大量的API调用适配问题。目前仅修复了主机管理模块，其他模块（用户管理、角色管理、审计日志等）仍使用旧的响应格式期望，导致功能异常。现有的responseAdapter.ts已经包含130+行的if-else判断，维护成本越来越高。需要采用渐进式架构升级方案，通过引入轻量级Service层，在保证现有功能正常的前提下，逐步解决响应格式问题并为长期发展打好基础。

## 用户故事
作为系统管理员，我希望所有管理功能页面都能正常工作，以便能够顺利进行用户管理、权限配置、审计查看等日常运维工作。

## 验收标准（EARS格式）
1. WHEN 访问任何管理页面时，系统 SHALL 正确显示数据列表而不是"暂无数据"
2. IF API返回分页数据，THEN 前端 SHALL 正确解析items字段并显示记录总数
3. WHILE 进行CRUD操作时，系统 SHALL 正确处理统一格式的API响应并更新界面状态
4. WHEN API调用失败时，系统 SHALL 显示准确的错误信息而非崩溃

## 功能需求
### 渐进式架构升级
- 创建轻量级BaseApiService基类，封装通用的HTTP请求和响应转换逻辑
- 将responseAdapter.ts的复杂逻辑迁移到BaseApiService中
- 保持现有API接口不变，仅在内部实现上使用Service模式
- 逐个模块渐进式迁移，确保每一步都稳定可靠

### 响应格式统一化
- 在BaseApiService中实现智能的响应格式识别和转换
- 统一将各种列表字段（users, roles, logs等）映射为items
- 处理嵌套的data.data结构
- 保留向后兼容性，支持旧格式的渐进式迁移

### API Service层建设
- 将现有API文件（userAPI.ts等）改造为继承自BaseApiService的类
- 每个Service类保持原有的公开接口，减少对Redux层的影响
- 在Service内部处理所有响应格式转换，对外提供统一格式
- 支持未来扩展（缓存、重试、离线等）

### Redux层优化
- 逐步移除对responseAdapter的依赖
- 直接使用Service返回的标准化数据
- 保持createAsyncThunk的现有结构，减少改动风险
- 简化错误处理逻辑

### 受影响模块清单
#### 第一批迁移（优先级高）
- userAPI.ts → UserApiService（用户管理核心功能）
- authAPI.ts → AuthApiService（登录认证基础功能）

#### 第二批迁移（中等优先级）
- auditAPI.ts → AuditApiService（审计日志模块）
- credentialSlice.ts对应的API
- sshSessionSlice.ts对应的API

#### 第三批迁移（低优先级）
- workspaceSlice.ts对应的API
- 其他辅助模块

#### 最终废弃
- responseAdapter.ts（所有模块迁移完成后）

## 非功能需求
### 性能需求
- 响应转换处理时间 < 5ms
- 保持现有网络请求性能不变
- 为未来缓存机制预留接口

### 渐进式迁移需求
- 每次只迁移一个模块，确保稳定性
- 保持向后兼容，旧代码可以继续工作
- 提供回退方案，出问题可以快速恢复

### 可维护性需求
- 代码结构清晰，新人容易理解
- 减少重复代码，提高开发效率
- 便于添加新的API模块
- 错误信息明确，方便调试

### 可测试性需求
- BaseApiService可独立测试
- 各Service类支持单元测试
- 保留现有测试用例的有效性

## 约束条件
### 技术约束
- 必须使用现有的Redux Toolkit架构
- 保持TypeScript严格模式
- 不能修改后端API接口
- 保持现有的axios配置和拦截器

### 业务约束
- 修复过程不能影响生产环境使用
- 需要保证数据完整性和一致性
- 每个阶段都要经过充分测试

### 时间约束
- 首个模块迁移在1-2天内完成
- 全部迁移在一周内完成

## 风险评估
### 技术风险
- 遗漏API调用点导致部分功能异常 - 概率：中，影响：高
- 类型定义不匹配导致运行时错误 - 概率：中，影响：中
- 响应适配器性能问题 - 概率：低，影响：中

### 缓解策略
- 遗漏调用点：使用自动化工具扫描所有API调用代码
- 类型不匹配：启用TypeScript严格检查，增加单元测试
- 性能问题：对适配器进行性能测试和优化

## 测试要求
### 单元测试
- 响应适配器的所有转换场景
- Redux reducers的状态更新逻辑

### 集成测试  
- 每个管理模块的CRUD操作流程
- 分页、搜索、过滤等功能

### 端到端测试
- 用户完整操作流程验证
- 异常情况处理验证