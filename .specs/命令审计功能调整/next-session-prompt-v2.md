# 下次会话提示词 - 命令审计历史命令绕过问题

我正在修复运维堡垒机系统的一个严重安全问题。项目路径：`/Users/skip/workspace/bastion`

## 问题描述
命令审计功能存在严重漏洞：通过上下键使用历史命令可以绕过命令过滤机制，执行危险命令。

## 问题详情
1. **正常情况**：手动输入 `rm -rf /` 会被正确拦截
2. **漏洞情况**：使用上下键调出历史命令中的 `rm` 可以执行

## 技术原因
- 手动输入的每个字符都会更新命令缓冲区
- 历史命令通过 SSH 输出流返回，不经过输入流处理
- 当按回车时，命令缓冲区为空，导致安全检查失效

## 需要实现的解决方案
请帮我实现一个可靠的解决方案，确保：
1. 无论是手动输入还是历史命令，都能被正确拦截
2. 不影响正常的命令行使用体验
3. 性能开销可接受

## 关键代码位置
- 文件：`/backend/controllers/ssh_controller.go`
- 方法：`updateCommandBuffer`、`getCommandFromBuffer`
- 当前问题：历史命令不经过 `updateCommandBuffer`

## 可选方案
1. **输出流解析**：从 SSH 输出解析当前命令
2. **服务器端拦截**：在 SSH 服务层实现拦截
3. **其他创新方案**：欢迎提出更好的解决方案

## 相关文档
- 问题详情：`.specs/命令审计功能调整/known-issues.md`
- 进度记录：`.specs/命令审计功能调整/progress.md`
- 需求文档：`.specs/命令审计功能调整/requirements.md`

请帮我实现一个完整、可靠的解决方案。