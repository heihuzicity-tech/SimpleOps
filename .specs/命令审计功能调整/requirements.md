# 命令审计功能调整 - 需求规格说明书

## 概述
当前命令审计功能记录了所有执行的命令，但这造成了大量不必要的日志记录。本次调整将优化命令记录逻辑，只记录命令过滤中配置的命令，并增强界面交互和信息展示。

## 用户故事
作为一个堡垒机管理员，我希望系统只记录我关心的命令（在命令过滤中配置的命令），并能够方便地查看命令执行的详细信息和录屏回放，以便更有效地进行安全审计。

## 验收标准（EARS格式）

1. **WHEN** 用户执行SSH命令时，**IF** 该命令匹配命令过滤规则，**THEN** 系统SHALL记录该命令到命令日志表
2. **WHEN** 用户执行SSH命令时，**IF** 该命令不匹配任何命令过滤规则，**THEN** 系统SHALL NOT记录该命令
3. **WHEN** 用户在命令审计页面查看会话ID时，**THEN** 会话ID SHALL显示为可点击的链接
4. **WHEN** 用户点击会话ID链接时，**THEN** 系统SHALL打开录屏回放播放器，显示该会话的录屏内容
5. **WHEN** 用户查看命令审计表格时，**THEN** "日期时间"列名SHALL显示为"执行时间"
6. **WHEN** 系统显示命令记录时，**THEN** 每条记录SHALL包含"指令类型"列，显示"指令阻断"、"指令放行"或"指令警告"状态
7. **WHEN** 用户查看命令审计表格时，**THEN** 操作列的宽度SHALL缩小到合理范围（从当前的过长状态调整为紧凑布局）

## 功能需求

### 1. 命令记录过滤
- 系统应只记录在命令过滤规则中配置的命令
- 执行命令时，先检查是否匹配任何命令过滤规则
- 只有匹配的命令才会被记录到command_logs表
- 不匹配的命令不产生任何日志记录

### 2. 会话ID链接功能
- 将会话ID列改为可点击的链接样式（蓝色、带下划线）
- 点击后触发录屏回放功能
- 复用现有的会话审计中的播放功能（RecordingPlayer组件）
- 如果该会话没有录屏文件，显示提示信息

### 3. 界面调整
- 将"日期时间"列标题改为"执行时间"
- 新增"指令类型"列，位置在命令列之后
- 缩小操作列宽度（当前width: 300，调整为width: 80）

### 4. 指令类型展示
- 根据命令过滤规则的action字段显示指令类型：
  - action = "block" → 显示"指令阻断"（红色标签）
  - action = "allow" → 显示"指令放行"（绿色标签）  
  - action = "warning" → 显示"指令警告"（橙色标签）

## 非功能需求

### 性能需求
- 命令过滤匹配检查响应时间 < 100ms
- 录屏回放加载时间 < 3秒

### 安全需求
- 保持现有的权限控制机制
- 录屏回放权限与会话审计权限一致

## 约束条件

### 技术约束
- 必须兼容现有的命令过滤系统
- 必须复用现有的录屏回放组件
- 不能影响现有的SSH会话功能

### 业务约束
- 历史命令日志数据保持不变
- 新规则只对新产生的命令生效

## 风险评估

### 技术风险
- **命令匹配性能问题** - 概率: 中, 影响: 高
  - 如果命令过滤规则过多，可能影响命令执行性能
  
- **录屏文件缺失** - 概率: 低, 影响: 中
  - 某些会话可能没有对应的录屏文件

### 缓解策略
- **命令匹配性能**: 使用缓存机制，优化匹配算法
- **录屏文件缺失**: 提供友好的提示信息，引导用户理解原因