# 命令策略功能 - 需求规格说明书

## 概述
命令策略功能旨在为堡垒机系统提供命令执行控制能力，通过黑名单机制限制危险命令的执行，提高系统安全性。该功能支持创建命令组，将策略与用户绑定，并在违规时进行拦截和审计记录。

## 用户故事
作为一名系统管理员，我希望能够限制某些用户执行危险命令，以便保护服务器安全，避免误操作造成的损失。

## 接受标准（EARS格式）
1. 当用户尝试执行被禁止的命令时，系统应当阻止该命令的执行并显示提示信息
2. 如果用户被绑定了命令策略，那么在SSH会话中输入的命令应当先经过策略检查
3. 当管理员创建命令组时，系统应当允许将多个命令添加到同一个组中
4. 如果命令被拦截，系统应当记录详细的审计日志，包括用户、时间、命令内容等信息
5. 当命令策略被修改后，用户下次SSH连接时应当使用新的策略规则

## 功能需求
### 命令管理
- 支持添加、编辑、删除单个命令
- 支持精确匹配和正则表达式匹配两种模式
- 每个命令可以设置描述信息

### 命令组管理
- 支持创建、编辑、删除命令组
- 一个命令可以属于多个命令组
- 提供预设的危险命令组（如：文件删除类、系统配置类、网络操作类）
- 命令组包含名称、描述、包含的命令列表

### 用户策略绑定
- 支持为用户绑定多个命令策略（命令或命令组）
- 黑名单模式：被绑定的命令/命令组将被禁止执行
- 策略立即生效（用户下次连接时）

### 命令拦截
- 在SSH会话中实时拦截被禁止的命令
- 拦截时在终端显示红色提示信息："命令 `xxx` 是被禁止的 ..."
- 阻止命令发送到目标服务器
- 不使用弹窗提醒，直接在命令行显示

### 审计记录
- 记录所有被拦截的命令尝试
- 审计信息包括：用户ID、用户名、会话ID、主机信息、命令内容、拦截时间、策略名称
- 与现有审计系统集成，保持日志格式一致

### 策略测试
- 提供策略测试功能，输入用户和命令，查看是否会被拦截
- 显示匹配到的策略规则

## 非功能需求
### 性能需求
- 命令检查响应时间 < 10ms
- 支持最多100条策略规则的快速匹配
- 策略缓存机制，避免频繁数据库查询

### 安全需求
- 只有管理员角色可以管理命令策略
- 策略变更需要记录操作审计日志
- 命令匹配在服务端进行，防止客户端绕过

## 约束条件
### 技术约束
- 基于现有的Go后端架构（Gin框架）
- 使用MySQL存储策略数据
- 前端使用React + TypeScript + Ant Design
- 通过WebSocket进行SSH终端通信

### 业务约束
- 暂不实现白名单模式
- 暂不实现命令审批流程
- 暂不实现告警通知功能（仅预留数据库字段）
- 策略修改后下次会话生效即可
- 菜单结构：访问控制（一级菜单）→ 命令过滤（子菜单）

## 风险评估
### 技术风险
- SSH命令拦截实现复杂度 - 概率：中，影响：高
- WebSocket消息处理性能 - 概率：低，影响：中
- 策略匹配性能问题 - 概率：低，影响：中

### 缓解策略
- SSH命令拦截：研究现有的terminal消息处理机制，在命令发送前进行拦截
- 性能优化：使用内存缓存策略规则，减少数据库查询
- 充分测试：确保命令拦截不影响正常的SSH会话功能