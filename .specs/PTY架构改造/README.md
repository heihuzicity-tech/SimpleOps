# PTY架构改造 - 项目总览

## 项目背景
当前堡垒机系统存在严重的安全漏洞：用户可以通过历史命令（上下键）绕过命令过滤机制。为彻底解决此问题，需要从WebSocket代理架构升级到PTY（伪终端）架构。

## 项目状态
- **创建日期**: 2025-01-31
- **当前状态**: 已完成需求和设计，暂时搁置
- **预计工期**: 6周
- **优先级**: 高（安全相关）

## 文档清单
1. **需求文档** ([requirements.md](./requirements.md))
   - 功能需求和非功能需求
   - 风险评估和缓解策略
   - 迁移计划

2. **技术设计** ([design.md](./design.md))
   - 详细架构设计
   - 核心组件说明
   - 实现算法

3. **任务规划** ([tasks.md](./tasks.md))
   - 41个具体任务
   - 3个实施阶段
   - 验收标准

4. **行业调研** ([industry-research.md](../修复命令拦截问题/industry-research.md))
   - 业内主流产品分析
   - 最佳实践总结
   - 技术趋势

## 核心价值
1. **彻底解决安全问题**: PTY架构从根本上杜绝命令绕过
2. **增强审计能力**: 完整的会话录制和回放
3. **更好的控制**: 环境隔离、资源限制
4. **业界标准**: JumpServer、Teleport等都采用此架构

## 快速开始（未来实施时）

### 第一步：原型验证
```bash
# 安装依赖
go get github.com/creack/pty

# 创建测试程序
cd backend/tests
go run pty_prototype.go
```

### 第二步：查看设计文档
重点关注以下组件：
- PTYManager: 核心PTY管理
- CommandInterceptor: 命令拦截
- TerminalRecorder: 会话录制

### 第三步：按任务执行
从 [tasks.md](./tasks.md) 的阶段一开始实施

## 技术要点总结

### 架构对比
| 特性 | 当前架构 | PTY架构 |
|-----|---------|---------|
| 命令获取 | 从输入流 | 从PTY直接获取 |
| 历史命令 | 可绕过 | 无法绕过 |
| 环境控制 | 无 | 完全控制 |
| 会话录制 | 基于WebSocket | 基于PTY |
| 资源限制 | 无 | 支持 |

### 关键代码示例
```go
// PTY会话创建
ptmx, pts, err := pty.Open()
cmd := exec.Command("/bin/bash")
cmd.Stdin = pts
cmd.Stdout = pts
cmd.Stderr = pts

// 命令拦截
if !isCommandAllowed(command) {
    ptmx.Write([]byte{0x03}) // Ctrl+C
    return
}
```

## 风险和注意事项
1. **兼容性**: 不同OS的PTY实现有差异
2. **性能**: 大量并发会话的资源消耗
3. **复杂度**: 调试和故障排查难度增加

## 相关问题和解决方案

### 当前问题
- 详见: [known-issues.md](../修复命令拦截问题/known-issues.md)
- 历史命令可以绕过安全检查
- 影响所有使用历史功能的场景

### 临时方案
- 详见: [修复命令拦截问题](../修复命令拦截问题/)
- 基于输出流解析的快速修复
- 可以先实施临时方案

### 长期方案
- 本PTY架构改造
- 从根本上解决问题
- 提供更多增强功能

## 下次继续时的检查清单
- [ ] 确认Go版本 >= 1.19
- [ ] 安装 github.com/creack/pty
- [ ] 准备测试环境（Linux/macOS）
- [ ] 复习设计文档
- [ ] 从任务1.1开始

## 联系和支持
- 项目负责人: [待定]
- 技术支持: [待定]
- 文档维护: AI助手

---
*本文档包含了PTY架构改造的所有关键信息，便于未来快速启动实施。*