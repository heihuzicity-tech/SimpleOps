# 命令过滤功能 API 测试指南

## 测试脚本说明

`api_test_command_filter.py` 是一个全面的 Python 测试脚本，用于验证命令过滤功能的所有 API 端点。

## 测试覆盖范围

### 1. 认证测试
- 用户登录
- Token 获取

### 2. 命令组管理
- 创建命令组（支持精确匹配和正则表达式）
- 获取命令组列表
- 获取命令组详情
- 更新命令组
- 删除命令组
- 批量删除命令组
- 导出/导入命令组

### 3. 过滤规则管理
- 创建过滤规则
- 获取过滤规则列表
- 获取过滤规则详情
- 更新过滤规则
- 删除过滤规则
- 启用/禁用规则切换
- 批量删除规则
- 导出/导入规则

### 4. 命令匹配测试
- 测试命令是否被规则匹配
- 验证匹配动作（deny/allow/alert/prompt_alert）

### 5. 日志功能
- 查询过滤日志
- 获取日志统计
- 按条件筛选日志

### 6. 错误处理
- 无效 ID 处理
- 重复名称处理
- 参数验证

### 7. 性能测试
- 批量创建性能
- 批量删除性能

## 使用方法

### 前置条件

1. 确保后端服务已启动：
```bash
cd backend
go run main.go
```

2. 确保数据库已正确配置并包含测试数据

3. 安装 Python 依赖：
```bash
pip install requests
```

### 运行测试

#### 全面测试（推荐）
```bash
python api_test_command_filter.py
```

#### 快速测试
```bash
python api_test_command_filter.py --quick
```

#### 自定义参数
```bash
# 指定 API 地址
python api_test_command_filter.py --url http://localhost:8080/api/v1

# 指定登录凭据
python api_test_command_filter.py --username admin --password your_password
```

## 测试输出说明

测试结果使用以下格式显示：
- ✅ PASS - 测试通过
- ❌ FAIL - 测试失败
- 📌 测试分组标记
- ⏱️ 性能指标

示例输出：
```
================================================================================
🚀 Bastion 命令过滤功能 API 测试
================================================================================

📌 认证测试
------------------------------------------------------------
✅ PASS | 用户登录                                          | Token: eyJhbGciOiJIUzI1...

📌 命令组 CRUD 测试
------------------------------------------------------------
✅ PASS | 创建命令组 [危险命令组_测试]                      | ID: 1
✅ PASS | 获取命令组列表                                    | 共 2 个命令组
✅ PASS | 获取命令组详情 [ID: 1]                           | 名称: 危险命令组_测试, 命令数: 3
```

## 测试数据清理

脚本会自动清理测试过程中创建的资源：
- 删除测试创建的过滤规则
- 删除测试创建的命令组
- 不会影响系统原有数据

## 常见问题

### 1. 连接失败
- 检查后端服务是否运行
- 确认 API 地址是否正确
- 检查防火墙设置

### 2. 认证失败
- 确认用户名密码正确
- 检查用户是否有管理员权限
- 验证 JWT 配置

### 3. 测试失败
- 查看具体错误信息
- 检查数据库连接
- 确认表结构是否正确

## 扩展测试

可以基于此脚本扩展更多测试场景：

1. **并发测试**：多线程同时请求
2. **压力测试**：大量数据测试
3. **边界测试**：极限值测试
4. **安全测试**：权限验证测试

## 集成到 CI/CD

可以将测试脚本集成到持续集成流程：

```yaml
# .gitlab-ci.yml 示例
test:
  stage: test
  script:
    - cd backend && go run main.go &
    - sleep 5  # 等待服务启动
    - python tests/api_test_command_filter.py --quick
```

## 测试报告

建议将测试结果输出到文件：

```bash
python api_test_command_filter.py > test_report_$(date +%Y%m%d_%H%M%S).log 2>&1
```

---

**注意**：测试脚本会创建名称包含"测试"的数据，便于识别和清理。请勿在生产环境运行全面测试。