<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>前端权限系统测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
        button { margin: 5px; padding: 5px 10px; }
    </style>
</head>
<body>
    <h1>前端权限系统测试</h1>
    
    <div class="test-section">
        <h2>1. 测试登录和获取用户信息</h2>
        <button onclick="testLogin()">执行登录测试</button>
        <div id="login-result"></div>
    </div>

    <div class="test-section">
        <h2>2. 测试权限检查函数</h2>
        <button onclick="testPermissions()">测试权限检查</button>
        <div id="permission-result"></div>
    </div>

    <div class="test-section">
        <h2>3. 测试菜单生成</h2>
        <button onclick="testMenuGeneration()">测试菜单生成</button>
        <div id="menu-result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1';
        let authToken = '';
        let currentUser = null;

        async function testLogin() {
            const resultDiv = document.getElementById('login-result');
            resultDiv.innerHTML = '<p class="info">正在执行登录测试...</p>';
            
            try {
                // 1. 登录
                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                const loginData = await loginResponse.json();
                console.log('登录响应:', loginData);
                
                if (loginData.success) {
                    authToken = loginData.data.access_token;
                    resultDiv.innerHTML += '<p class="success">✓ 登录成功</p>';
                    resultDiv.innerHTML += `<pre>${JSON.stringify(loginData, null, 2)}</pre>`;
                    
                    // 2. 获取用户信息
                    const profileResponse = await fetch(`${API_BASE}/profile`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const profileData = await profileResponse.json();
                    console.log('Profile响应:', profileData);
                    
                    if (profileData.success) {
                        currentUser = profileData.data;
                        resultDiv.innerHTML += '<p class="success">✓ 获取用户信息成功</p>';
                        resultDiv.innerHTML += `<pre>${JSON.stringify(profileData, null, 2)}</pre>`;
                        
                        // 检查角色信息
                        if (currentUser.roles && currentUser.roles.length > 0) {
                            resultDiv.innerHTML += '<p class="success">✓ 用户角色信息存在</p>';
                            resultDiv.innerHTML += `<p>用户角色: ${currentUser.roles.map(r => r.name).join(', ')}</p>`;
                        } else {
                            resultDiv.innerHTML += '<p class="error">✗ 用户角色信息缺失</p>';
                        }
                    } else {
                        resultDiv.innerHTML += '<p class="error">✗ 获取用户信息失败</p>';
                    }
                } else {
                    resultDiv.innerHTML += '<p class="error">✗ 登录失败</p>';
                }
            } catch (error) {
                resultDiv.innerHTML += `<p class="error">✗ 测试失败: ${error.message}</p>`;
                console.error('测试错误:', error);
            }
        }

        function hasRole(roleName) {
            if (!currentUser || !currentUser.roles) return false;
            return currentUser.roles.some(role => role.name === roleName);
        }

        function hasAnyRole(roleNames) {
            if (!currentUser || !currentUser.roles) return false;
            return currentUser.roles.some(role => roleNames.includes(role.name));
        }

        async function testPermissions() {
            const resultDiv = document.getElementById('permission-result');
            
            if (!currentUser) {
                resultDiv.innerHTML = '<p class="error">请先执行登录测试</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="info">正在测试权限检查函数...</p>';
            
            // 测试权限检查函数
            const tests = [
                { name: 'hasRole("admin")', result: hasRole('admin') },
                { name: 'hasRole("user")', result: hasRole('user') },
                { name: 'hasRole("operator")', result: hasRole('operator') },
                { name: 'hasAnyRole(["admin", "user"])', result: hasAnyRole(['admin', 'user']) },
                { name: 'hasAnyRole(["operator", "auditor"])', result: hasAnyRole(['operator', 'auditor']) }
            ];
            
            let html = '<h3>权限检查结果:</h3><ul>';
            tests.forEach(test => {
                const statusClass = test.result ? 'success' : 'info';
                const statusIcon = test.result ? '✓' : '✗';
                html += `<li class="${statusClass}">${statusIcon} ${test.name}: ${test.result}</li>`;
            });
            html += '</ul>';
            
            resultDiv.innerHTML += html;
        }

        async function testMenuGeneration() {
            const resultDiv = document.getElementById('menu-result');
            
            if (!currentUser) {
                resultDiv.innerHTML = '<p class="error">请先执行登录测试</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="info">正在测试菜单生成...</p>';
            
            // 模拟菜单项配置
            const menuItems = [
                { name: '仪表板', path: '/dashboard', roles: [] },
                { name: '用户管理', path: '/users', roles: ['admin'] },
                { name: '角色管理', path: '/roles', roles: ['admin'] },
                { name: '资产管理', path: '/assets', roles: ['admin', 'operator'] },
                { name: '凭证管理', path: '/credentials', roles: ['admin', 'operator'] },
                { name: 'SSH会话', path: '/ssh-sessions', roles: ['admin', 'operator', 'user'] },
                { name: '审计日志', path: '/audit-logs', roles: [] },
                { name: '系统设置', path: '/settings', roles: ['admin'] }
            ];
            
            // 生成可见菜单
            const visibleMenus = menuItems.filter(item => {
                if (item.roles.length === 0) return true;
                return hasAnyRole(item.roles);
            });
            
            let html = '<h3>可见菜单项:</h3><ul>';
            visibleMenus.forEach(menu => {
                html += `<li class="success">✓ ${menu.name} (${menu.path})</li>`;
            });
            html += '</ul>';
            
            html += '<h3>隐藏菜单项:</h3><ul>';
            menuItems.filter(item => !visibleMenus.includes(item)).forEach(menu => {
                html += `<li class="info">✗ ${menu.name} (需要角色: ${menu.roles.join(', ')})</li>`;
            });
            html += '</ul>';
            
            resultDiv.innerHTML += html;
            
            // 统计信息
            resultDiv.innerHTML += `<p class="info">菜单统计: 可见 ${visibleMenus.length}/${menuItems.length} 项</p>`;
        }
    </script>
</body>
</html>