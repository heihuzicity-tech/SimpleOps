<!DOCTYPE html>
<html>
<head>
    <title>WebSocket测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #terminal { 
            background: #000; 
            color: #fff; 
            padding: 10px; 
            font-family: monospace; 
            height: 400px; 
            overflow-y: auto; 
            border: 1px solid #ccc;
        }
        .controls { margin: 10px 0; }
        button { margin: 5px; padding: 5px 10px; }
        input { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <h1>WebSocket SSH连接测试</h1>
    
    <div class="controls">
        <button onclick="connect()">连接</button>
        <button onclick="disconnect()">断开</button>
        <button onclick="sendCommand()">发送命令</button>
        <input type="text" id="command" placeholder="输入命令" />
    </div>
    
    <div id="terminal"></div>
    
    <script>
        let ws = null;
        
        function log(message) {
            const terminal = document.getElementById('terminal');
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function connect() {
            const sessionId = 'ssh-1752748965-7914251547967215843';
            const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6ImFkbWluIiwiaXNzIjoiYmFzdGlvbiIsInN1YiI6ImFkbWluIiwiZXhwIjoxNzUyODM1MDg4LCJuYmYiOjE3NTI3NDg2ODgsImlhdCI6MTc1Mjc0ODY4OCwianRpIjoiYjc0MDUzYjctZDFlMS00NGYzLWEyOTgtMjExZDdkZmVlMTAzIn0.YGrbfyy-ommVQeZPUm4JnPt9S-meMl3aa094O89IOvI';
            
            const wsUrl = `ws://localhost:8080/api/v1/ws/ssh/sessions/${sessionId}/ws?token=${token}`;
            log('连接到: ' + wsUrl);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                log('WebSocket连接已建立');
                
                // 发送初始化命令
                setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const msg = {
                            type: 'input',
                            data: '\n'
                        };
                        ws.send(JSON.stringify(msg));
                        log('已发送初始化命令');
                    }
                }, 200);
            };
            
            ws.onmessage = function(event) {
                try {
                    const msg = JSON.parse(event.data);
                    log('收到消息: ' + msg.type + ' - ' + JSON.stringify(msg.data));
                    
                    if (msg.type === 'output') {
                        // 显示输出
                        const output = document.createElement('span');
                        output.style.color = '#00ff00';
                        output.textContent = msg.data;
                        document.getElementById('terminal').appendChild(output);
                    }
                } catch (e) {
                    log('解析消息失败: ' + e.message);
                }
            };
            
            ws.onclose = function(event) {
                log('WebSocket连接已关闭: ' + event.code + ' - ' + event.reason);
            };
            
            ws.onerror = function(error) {
                log('WebSocket错误: ' + error.message);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                log('已断开连接');
            }
        }
        
        function sendCommand() {
            const command = document.getElementById('command').value;
            if (!command || !ws || ws.readyState !== WebSocket.OPEN) {
                log('无法发送命令');
                return;
            }
            
            const msg = {
                type: 'input',
                data: command + '\n'
            };
            
            ws.send(JSON.stringify(msg));
            log('已发送命令: ' + command);
            document.getElementById('command').value = '';
        }
        
        // 回车键发送命令
        document.getElementById('command').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendCommand();
            }
        });
    </script>
</body>
</html>