# 审计功能规范文档

## 概述
本文档基于 OpsAny 堡垒机审计功能标准，定义了我们项目中审计模块的功能规范和开发标准。

## 当前实现状态
### 后端实现情况
- ✅ 基础审计服务架构 (`services/audit_service.go`)
- ✅ 审计控制器 (`controllers/audit_controller.go`)
- ✅ 完整的API接口
- ✅ 数据库模型支持

### 前端实现情况
- ❌ 前端页面仅有基础框架 (`AuditLogsPage.tsx`)
- ❌ 缺少具体的审计功能界面

## 四大核心审计功能模块

### 1. 在线会话监控
**功能描述：** 实时监控活跃会话，防止违规操作

**当前实现状态：**
- ✅ 后端API: `GET /audit/session-records`
- ✅ 会话状态追踪 (active/closed/terminated)
- ❌ 前端实时监控界面
- ❌ 会话强制终止功能

**需要补充的功能：**
- 实时会话列表显示
- 会话详情查看
- 管理员强制终止会话
- 实时会话状态更新（WebSocket）

### 2. 历史会话审计
**功能描述：** 会话结束后的详细操作记录和回放功能

**当前实现状态：**
- ✅ 后端API: `GET /audit/session-records/{id}`
- ✅ 会话记录存储
- ❌ 会话回放功能
- ❌ 操作重现界面

**需要补充的功能：**
- Linux会话：操作回放和命令文本显示
- Windows会话：视频格式操作回放
- 会话录制文件存储和播放
- 会话时间轴导航

### 3. 审计历史（系统命令日志）
**功能描述：** 追踪系统命令日志和详细的系统级操作记录

**当前实现状态：**
- ✅ 后端API: `GET /audit/command-logs`
- ✅ 命令风险等级评估
- ✅ 命令执行记录
- ❌ 前端命令日志查看界面
- ❌ 危险命令告警

**需要补充的功能：**
- 命令日志列表和搜索
- 命令风险等级显示
- 危险命令实时告警
- 命令执行统计分析

### 4. 操作日志管理
**功能描述：** 记录用户在堡垒机平台内的所有操作

**当前实现状态：**
- ✅ 后端API: `GET /audit/operation-logs`
- ✅ 操作日志中间件
- ✅ 自动记录所有API调用
- ❌ 前端操作日志界面

**需要补充的功能：**
- 操作日志查看和筛选
- 操作统计和分析
- 异常操作告警
- 用户行为分析

## API接口清单

### 已实现的API接口
1. **登录日志**
   - `GET /audit/login-logs` - 获取登录日志列表
   
2. **操作日志**
   - `GET /audit/operation-logs` - 获取操作日志列表
   - `GET /audit/operation-logs/{id}` - 获取单个操作日志详情

3. **会话记录**
   - `GET /audit/session-records` - 获取会话记录列表
   - `GET /audit/session-records/{id}` - 获取单个会话记录详情

4. **命令日志**
   - `GET /audit/command-logs` - 获取命令日志列表
   - `GET /audit/command-logs/{id}` - 获取单个命令日志详情

5. **统计数据**
   - `GET /audit/statistics` - 获取审计统计数据

6. **日志管理**
   - `POST /audit/cleanup` - 清理过期审计日志

### 需要新增的API接口
1. **实时监控**
   - `GET /audit/active-sessions` - 获取活跃会话列表
   - `POST /audit/sessions/{id}/terminate` - 强制终止会话
   - WebSocket接口支持实时更新

2. **会话回放**
   - `GET /audit/sessions/{id}/replay` - 获取会话回放数据
   - `GET /audit/sessions/{id}/recording` - 下载会话录制文件

## 数据模型

### 已实现的模型
- `LoginLog` - 登录日志
- `OperationLog` - 操作日志  
- `SessionRecord` - 会话记录
- `CommandLog` - 命令日志

### 需要扩展的字段
- 会话录制文件路径
- 回放时间戳数据
- 告警配置信息

## 审计配置参数

### 当前配置项
```yaml
audit:
  enable_operation_log: true      # 启用操作日志
  enable_session_record: true     # 启用会话记录
  retention_days: 365            # 日志保留天数
  dangerous_commands:            # 危险命令列表
    - "rm -rf"
    - "mkfs"
    - "dd"
    - "shutdown"
    - "reboot"
```

### 需要新增的配置
- 会话录制存储路径
- 实时告警阈值
- 回放文件格式设置
- WebSocket连接配置

## 安全与权限

### 当前权限控制
- 管理员才能清理审计日志
- 用户只能查看自己相关的日志

### 需要完善的权限
- 会话监控权限分级
- 敏感操作审批流程
- 审计数据访问控制

## 性能要求

### 数据量估算
- 单日登录日志：1000条
- 单日操作日志：10000条
- 单日会话记录：500条
- 单日命令日志：50000条

### 性能指标
- 日志查询响应时间 < 2秒
- 实时监控延迟 < 500ms
- 会话回放加载时间 < 5秒

## 开发优先级

### 高优先级（必须完成）
1. 完善前端审计日志界面
2. 实现会话实时监控
3. 添加命令日志查看功能
4. 操作日志管理界面

### 中优先级（重要功能）
1. 会话回放功能
2. 实时告警系统
3. 审计数据统计分析
4. WebSocket实时更新

### 低优先级（增强功能）
1. 高级搜索和过滤
2. 审计报表生成
3. 数据导出功能
4. 移动端适配

## 技术实现细节

### 前端技术栈
- React + TypeScript
- Ant Design 组件库
- WebSocket 实时通信
- Video.js 或类似库用于回放

### 后端扩展
- WebSocket 服务支持
- 文件上传/下载服务
- 定时任务清理
- 告警推送服务

### 存储要求
- 会话录制文件存储（本地/云存储）
- 时序数据库优化（可选）
- 索引优化策略

---

*本文档将随着开发进度持续更新*