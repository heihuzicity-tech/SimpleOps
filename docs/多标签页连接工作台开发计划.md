# 多标签页连接工作台开发计划

## 📋 项目概述

基于用户需求分析，我们计划实现一个现代化的多标签页连接工作台，提供类似 VS Code 终端或现代 IDE 的用户体验。用户可以在一个页面中管理多个SSH连接，通过标签页快速切换不同的主机会话。

## 🎯 功能目标

### 核心功能
- **统一工作台界面**：左侧资源树 + 右侧多标签页终端
- **多会话管理**：同时维护多个SSH连接，独立的WebSocket通道
- **标签页系统**：可创建、关闭、重命名、重排序标签页
- **会话持久化**：页面刷新后保持连接状态
- **快捷键支持**：提供常用快捷键操作

### 增强功能
- **连接状态指示**：实时显示各个连接的健康状态
- **会话历史**：保存和恢复历史连接
- **拖拽排序**：支持标签页拖拽重排序
- **全屏模式**：支持单个标签页全屏显示

## 🏗️ 系统架构设计

### 页面布局结构
```
连接工作台页面 (/connect/workspace)
├── 左侧栏 (250px, 可调整)
│   ├── 资源树组件 (复用现有 ResourceTree)
│   ├── 快速搜索功能
│   ├── 连接历史记录
│   └── 收藏夹功能
├── 主内容区域
│   ├── 标签页头部
│   │   ├── 标签1: web-7 (root@10.0.0.51) [x]
│   │   ├── 标签2: db-master (mysql) [x]
│   │   ├── 标签3: app-server (ubuntu) [x]
│   │   └── + 新建连接按钮
│   └── 标签页内容区域
│       └── WebTerminal 组件实例
└── 底部状态栏
    ├── 连接状态统计
    └── 系统信息
```

### 核心组件设计

#### 1. WorkspaceLayout 组件
```typescript
// /frontend/src/pages/connect/WorkspaceLayout.tsx
interface WorkspaceLayoutProps {
  // 主要配置项
}

const WorkspaceLayout: React.FC<WorkspaceLayoutProps> = () => {
  // 实现主要的布局逻辑
};
```

#### 2. TabManager 组件
```typescript
// /frontend/src/components/workspace/TabManager.tsx
interface TabInfo {
  id: string;
  title: string;
  type: 'ssh' | 'database' | 'rdp';
  sessionId: string;
  assetInfo: {
    name: string;
    address: string;
    port: number;
  };
  credentialInfo: {
    username: string;
    type: string;
  };
  closable: boolean;
  modified: boolean;
  connectionStatus: 'connected' | 'connecting' | 'disconnected' | 'error';
}

interface TabManagerProps {
  tabs: TabInfo[];
  activeTabId: string;
  onTabChange: (tabId: string) => void;
  onTabClose: (tabId: string) => void;
  onTabCreate: () => void;
}
```

#### 3. ConnectionPanel 组件
```typescript
// /frontend/src/components/workspace/ConnectionPanel.tsx
interface ConnectionPanelProps {
  tab: TabInfo;
  onClose: () => void;
  onError: (error: Error) => void;
}
```

### 状态管理设计

#### 扩展 Redux Store
```typescript
// /frontend/src/store/workspaceSlice.ts
interface WorkspaceState {
  // 标签页管理
  tabs: TabInfo[];
  activeTabId: string;
  
  // 会话管理
  sessions: Record<string, SessionState>;
  
  // UI状态
  sidebarWidth: number;
  sidebarCollapsed: boolean;
  
  // 连接历史
  connectionHistory: ConnectionHistoryItem[];
  
  // 用户偏好
  preferences: {
    autoReconnect: boolean;
    maxTabs: number;
    defaultTerminalSize: { width: number; height: number };
  };
}

interface SessionState {
  sessionId: string;
  websocket: WebSocket | null;
  status: ConnectionStatus;
  lastActivity: Date;
  reconnectCount: number;
}
```

## 🔧 技术实现方案

### 第一阶段：基础架构搭建 (预计 3-4 工作日)

#### 任务清单
- [ ] 创建 `WorkspaceLayout` 主要布局组件
- [ ] 实现左右分栏布局，支持拖拽调整宽度
- [ ] 集成现有的 `ResourceTree` 组件到左侧栏
- [ ] 创建基础的标签页容器组件
- [ ] 添加新的路由配置 `/connect/workspace`

#### 技术要点
- 使用 Ant Design 的 `Layout` 和 `Splitter` 组件
- 响应式布局设计，适配不同屏幕尺寸
- 保持与现有UI风格的一致性

#### 文件结构
```
frontend/src/
├── pages/connect/
│   └── WorkspaceLayout.tsx (新增)
├── components/workspace/ (新增目录)
│   ├── TabManager.tsx
│   ├── ConnectionPanel.tsx
│   └── SidePanel.tsx
└── store/
    └── workspaceSlice.ts (新增)
```

### 第二阶段：标签页系统实现 (预计 5-6 工作日)

#### 任务清单
- [ ] 实现 `TabManager` 组件
- [ ] 添加标签页的增删改查功能
- [ ] 集成 `WebTerminal` 组件到标签页
- [ ] 实现标签页切换逻辑
- [ ] 添加标签页右键菜单功能

#### 技术要点
- 使用 Ant Design 的 `Tabs` 组件作为基础
- 自定义标签页头部，显示连接状态和操作按钮
- 实现标签页的懒加载，提高性能

#### 核心功能
- 标签页创建：通过左侧资源树选择主机创建新连接
- 标签页关闭：支持单个关闭和批量关闭
- 标签页重命名：双击标签页标题进行重命名
- 连接状态显示：实时显示各个连接的状态

### 第三阶段：多会话管理 (预计 4-5 工作日)

#### 任务清单
- [ ] 扩展 `sshSessionSlice` 支持多会话管理
- [ ] 实现 WebSocket 连接池管理
- [ ] 添加会话持久化功能
- [ ] 实现自动重连机制
- [ ] 添加会话健康检查

#### 技术要点
- 每个标签页维护独立的 WebSocket 连接
- 统一的连接状态管理和错误处理
- 使用 IndexedDB 或 localStorage 持久化会话信息

#### WebSocket 连接池设计
```typescript
class WebSocketPool {
  private connections: Map<string, WebSocket>;
  private reconnectTimers: Map<string, NodeJS.Timeout>;
  
  createConnection(sessionId: string): Promise<WebSocket>;
  closeConnection(sessionId: string): void;
  reconnectConnection(sessionId: string): void;
  healthCheck(): void;
}
```

### 第四阶段：优化和完善 (预计 3-4 工作日)

#### 任务清单
- [ ] 添加快捷键支持
- [ ] 实现标签页拖拽排序
- [ ] 性能优化和内存管理
- [ ] 错误处理和用户反馈
- [ ] 添加单元测试和集成测试

#### 快捷键设计
- `Ctrl+T` / `Cmd+T`: 新建连接
- `Ctrl+W` / `Cmd+W`: 关闭当前标签页
- `Ctrl+Tab`: 切换到下一个标签页
- `Ctrl+Shift+Tab`: 切换到上一个标签页
- `Ctrl+1~9`: 切换到指定编号的标签页

#### 性能优化
- 虚拟滚动：处理大量标签页时的性能问题
- 内存管理：及时清理关闭的连接和相关资源
- 懒加载：非活跃标签页的内容延迟加载

## 🗂️ 数据库设计

### 连接历史表
```sql
CREATE TABLE connection_history (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  asset_id INT NOT NULL,
  credential_id INT NOT NULL,
  connection_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  duration INT DEFAULT 0,
  status VARCHAR(20) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (asset_id) REFERENCES assets(id),
  FOREIGN KEY (credential_id) REFERENCES credentials(id)
);
```

### 用户偏好表
```sql
CREATE TABLE user_preferences (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  preference_key VARCHAR(100) NOT NULL,
  preference_value JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (user_id) REFERENCES users(id),
  UNIQUE KEY unique_user_preference (user_id, preference_key)
);
```

## 🔄 后端API扩展

### 新增API端点
```go
// 工作台相关API
GET    /api/workspace/tabs                    // 获取用户的标签页配置
POST   /api/workspace/tabs                    // 保存标签页配置
DELETE /api/workspace/tabs/:id               // 删除标签页配置

// 连接历史API
GET    /api/connections/history              // 获取连接历史
POST   /api/connections/history              // 记录连接历史
DELETE /api/connections/history/:id          // 删除历史记录

// 用户偏好API
GET    /api/preferences                      // 获取用户偏好
PUT    /api/preferences                      // 更新用户偏好
```

### 后端服务扩展
```go
// /backend/services/workspace_service.go
type WorkspaceService struct {
    db *gorm.DB
}

func (s *WorkspaceService) GetUserTabs(userID uint) ([]TabConfig, error)
func (s *WorkspaceService) SaveUserTabs(userID uint, tabs []TabConfig) error
func (s *WorkspaceService) GetConnectionHistory(userID uint) ([]ConnectionHistory, error)
```

## 🧪 测试计划

### 单元测试
- 组件单元测试：使用 Jest + React Testing Library
- 状态管理测试：Redux slice 的单元测试
- 工具函数测试：WebSocket 连接池、工具函数等

### 集成测试
- 端到端测试：使用 Cypress 测试完整的用户流程
- WebSocket 连接测试：模拟各种网络情况
- 多标签页交互测试：验证标签页之间的独立性

### 性能测试
- 内存使用测试：长时间运行的内存泄漏检查
- 并发连接测试：同时打开多个连接的性能表现
- 响应时间测试：各种操作的响应时间基准测试

## 📊 项目里程碑

### 里程碑 1：基础架构完成 (第1周)
- 完成主要布局组件
- 实现左右分栏和基础交互
- 集成现有资源树组件

### 里程碑 2：标签页系统可用 (第2周)
- 标签页增删改查功能完整
- 基本的连接创建和管理
- 与现有终端组件集成

### 里程碑 3：多会话管理稳定 (第3周)
- 多个WebSocket连接同时工作
- 会话持久化和恢复
- 自动重连机制

### 里程碑 4：功能完善和优化 (第4周)
- 快捷键和拖拽功能
- 性能优化和测试
- 文档和部署准备

## 🚀 部署和发布

### 发布策略
1. **内部测试版本**：先在开发环境充分测试
2. **灰度发布**：逐步向部分用户开放
3. **全量发布**：经过充分验证后全面推广

### 兼容性考虑
- 保持现有单终端页面的兼容性
- 提供配置选项让用户选择使用新旧界面
- 平滑的迁移路径和用户引导

## 📚 文档计划

### 用户文档
- 新功能使用指南
- 快捷键说明
- 常见问题解答

### 开发文档
- 架构设计文档
- API接口文档
- 组件使用说明

## 🎯 成功标准

### 功能完整性
- [ ] 所有核心功能正常工作
- [ ] 性能满足要求（支持同时开启10+个连接）
- [ ] 稳定性测试通过

### 用户体验
- [ ] 界面响应流畅，操作直观
- [ ] 快捷键和交互符合用户习惯
- [ ] 错误处理友好，提供清晰的反馈

### 技术指标
- [ ] 代码覆盖率 > 80%
- [ ] 性能测试通过
- [ ] 无严重安全漏洞

---

**文档版本**: v1.0  
**创建日期**: 2025-07-17  
**最后更新**: 2025-07-17  
**负责人**: 开发团队  
**审核人**: 技术负责人  

## 📞 联系方式

如有问题或建议，请联系：
- 项目经理：[联系方式]
- 技术负责人：[联系方式]
- 开发团队：[联系方式]