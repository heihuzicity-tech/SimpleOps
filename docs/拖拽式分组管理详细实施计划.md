# 拖拽式分组管理详细实施计划

## 项目概述

**项目名称**: 拖拽式分组管理功能实现  
**项目目标**: 在资源管理菜单下创建分组管理页面，提供直观的拖拽式分组编辑体验  
**预计工期**: 5-6天  
**技术栈**: React + TypeScript + @dnd-kit + Ant Design  

## 架构设计

### 菜单结构调整
```
资源管理
├─ 主机资源 (/assets/hosts) - 只读查看模式
├─ 数据库 (/assets/databases) - 只读查看模式
└─ 分组管理 (/assets/groups) - 拖拽编辑模式 ← 新增
```

### 功能职责分工
- **主机资源页面**: 专注于资产展示，左侧分组树只读，用于筛选查看
- **分组管理页面**: 专门负责分组编辑，支持拖拽式资产分组管理

## 详细实施步骤

### Phase 1: 创建分组管理页面基础架构 (1-2天)

#### 1.1 路由和菜单配置
- [ ] 在路由配置文件中添加新路由 `/assets/groups`
- [ ] 更新侧边栏菜单组件，添加"分组管理"二级菜单项
- [ ] 配置页面权限控制（如需要）
- [ ] 测试路由跳转和菜单导航

#### 1.2 创建页面组件结构
- [ ] 创建 `src/pages/GroupManagePage.tsx` 主页面组件
- [ ] 创建 `src/components/groups/GroupEditor.tsx` 分组编辑器组件  
- [ ] 创建 `src/components/groups/AssetGroupList.tsx` 资产列表组件
- [ ] 设计基础布局：左右分栏布局（左侧分组树 + 右侧资产列表）
- [ ] 实现响应式布局，适配不同屏幕尺寸

#### 1.3 基础数据和状态管理
- [ ] 集成现有的分组API (`getAssetGroups`, `createAssetGroup`, `deleteAssetGroup`)
- [ ] 实现分组数据的加载、显示和错误处理
- [ ] 实现选中分组后对应资产列表的加载
- [ ] 添加加载状态和空数据状态的处理

### Phase 2: 实现拖拽功能核心逻辑 (2天)

#### 2.1 拖拽库配置
- [x] 安装依赖: `@dnd-kit/core`、`@dnd-kit/sortable`、`@dnd-kit/utilities`
- [ ] 在GroupManagePage中创建 `DndContext` 拖拽上下文
- [ ] 配置拖拽传感器（鼠标、触摸、键盘）
- [ ] 设置碰撞检测算法

#### 2.2 实现资产拖拽功能
- [ ] 使用 `useDraggable` Hook 将右侧资产列表项设置为可拖拽
- [ ] 实现拖拽开始时的视觉反馈（半透明、阴影等）
- [ ] 添加拖拽预览效果和自定义拖拽图标
- [ ] 实现多选资产的批量拖拽功能
- [ ] 处理拖拽边界和约束条件

#### 2.3 实现分组接收功能  
- [ ] 使用 `useDroppable` Hook 将左侧分组树节点设置为可接收
- [ ] 实现分组节点悬停时的高亮效果和视觉反馈
- [ ] 处理拖拽释放 `onDragEnd` 事件
- [ ] 实现拖拽数据的传递和验证
- [ ] 添加拖拽冲突检测（如资产已在目标分组中）

### Phase 3: 集成API和数据流 (1天)

#### 3.1 后端API集成
- [ ] 设计并实现批量移动资产到分组的API接口
  ```
  POST /api/assets/batch-move
  Body: {
    asset_ids: number[],
    target_group_id: number,
    source_group_id?: number
  }
  ```
- [ ] 实现拖拽完成后的API调用逻辑
- [ ] 添加API错误处理和重试机制
- [ ] 实现操作成功后的用户反馈

#### 3.2 数据同步和状态管理
- [ ] 实现拖拽操作后的本地状态立即更新（乐观更新）
- [ ] 刷新分组统计数量显示
- [ ] 同步更新左侧分组树和右侧资产列表
- [ ] 处理API失败时的状态回滚
- [ ] 实现数据缓存和防重复请求

### Phase 4: 优化用户体验和界面 (1天)

#### 4.1 交互优化
- [ ] 添加拖拽开始/进行/结束的平滑动画效果
- [ ] 实现拖拽操作的撤销功能（可选）
- [ ] 添加拖拽轨迹预览和吸附效果
- [ ] 优化拖拽在不同设备上的体验（PC、平板、手机）

#### 4.2 界面美化和用户引导
- [ ] 设计统一的拖拽图标和样式规范
- [ ] 添加空分组和空资产列表的友好提示
- [ ] 实现拖拽区域的边界高亮和引导线
- [ ] 添加首次使用的操作提示和帮助文档

#### 4.3 状态反馈和错误处理
- [ ] 实现操作成功/失败的Toast消息提示
- [ ] 添加加载状态指示器（拖拽中、保存中等）
- [ ] 完善错误场景的用户提示和恢复建议
- [ ] 实现操作日志记录（可选）

### Phase 5: 修改现有页面和代码清理 (0.5天)

#### 5.1 修改主机资源页面 (AssetsPage.tsx)
- [ ] 移除现有的分组管理弹窗相关代码
- [ ] 将"分组管理"按钮改为跳转到新页面的链接
- [ ] 优化左侧ResourceTree组件为纯查看模式
- [ ] 移除不必要的分组编辑权限检查

#### 5.2 代码重构和清理
- [ ] 提取可复用的分组操作逻辑到公共服务
- [ ] 更新相关的TypeScript类型定义
- [ ] 移除冗余的组件和工具函数
- [ ] 统一分组相关的常量和配置

#### 5.3 文档和注释
- [ ] 为新组件添加详细的JSDoc注释
- [ ] 更新API文档和使用说明
- [ ] 创建组件使用示例和最佳实践指南

### Phase 6: 测试和验证 (0.5天)

#### 6.1 功能测试
- [ ] 测试基础拖拽功能的各种场景
- [ ] 测试批量选择和批量拖拽操作
- [ ] 测试边界条件和异常场景处理
- [ ] 验证权限控制和数据安全性

#### 6.2 用户体验测试
- [ ] 测试拖拽操作的响应速度和流畅度
- [ ] 验证在不同浏览器和设备上的兼容性
- [ ] 检查界面一致性和视觉效果
- [ ] 收集测试反馈并进行优化调整

## 技术实现要点

### 核心组件架构
```
GroupManagePage (主页面)
├── DndContext (拖拽上下文)
├── Layout.Sider (左侧面板)
│   └── GroupTreePanel (分组树面板)
│       └── DroppableGroupNode (可接收的分组节点)
└── Layout.Content (右侧面板)
    └── AssetListPanel (资产列表面板)
        ├── AssetSelectionToolbar (批量操作工具栏)
        └── DraggableAssetItem (可拖拽的资产项)
```

### 关键API接口设计
```typescript
// 批量移动资产接口
POST /api/assets/batch-move
Body: {
  asset_ids: number[];
  target_group_id: number;
  source_group_id?: number;
}

// 获取分组资产列表
GET /api/groups/{groupId}/assets?page=1&page_size=20

// 分组统计信息
GET /api/groups/statistics
```

### 状态管理结构
```typescript
interface GroupManageState {
  groups: AssetGroup[];
  selectedGroupId: number | null;
  selectedAssets: number[];
  draggedAssets: number[];
  loading: {
    groups: boolean;
    assets: boolean;
    moving: boolean;
  };
  error: string | null;
}
```

## 风险评估和应对策略

### 技术风险
- **拖拽性能问题**: 使用虚拟化和防抖优化大量数据的拖拽
- **浏览器兼容性**: 充分测试主流浏览器，提供降级方案
- **移动端适配**: 优化触摸操作，考虑小屏幕的用户体验

### 用户体验风险
- **学习成本**: 提供操作引导和帮助文档
- **误操作**: 实现撤销功能和操作确认
- **数据同步**: 确保UI状态与后端数据的一致性

## 验收标准

### 功能要求
- [x] 支持单个和批量资产的拖拽移动
- [x] 分组树支持接收拖拽的资产
- [x] 实时更新分组统计和资产列表
- [x] 提供直观的视觉反馈和操作提示

### 性能要求
- [x] 拖拽操作响应时间 < 200ms
- [x] 页面加载时间 < 3s
- [x] 支持1000+资产的流畅操作

### 兼容性要求
- [x] 支持Chrome、Firefox、Safari、Edge最新版本
- [x] 响应式设计，适配PC和平板设备
- [x] 支持键盘导航和无障碍访问

## 项目里程碑

| 阶段 | 完成时间 | 关键产出 | 验收标准 |
|------|----------|----------|----------|
| Phase 1 | 第2天 | 基础页面和路由 | 页面可访问，基础布局完成 |
| Phase 2 | 第4天 | 拖拽功能实现 | 基础拖拽操作正常工作 |
| Phase 3 | 第5天 | API集成完成 | 拖拽操作可持久化到后端 |
| Phase 4 | 第5.5天 | 用户体验优化 | 界面美观，交互流畅 |
| Phase 5 | 第6天 | 代码清理完成 | 移除冗余代码，文档完善 |
| Phase 6 | 第6天 | 测试验收 | 所有功能测试通过 |

---

**文档创建时间**: 2025-07-15  
**最后更新时间**: 2025-07-15  
**负责人**: Claude Code Assistant  
**项目状态**: 规划阶段 → 待开始实施