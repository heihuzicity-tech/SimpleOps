# Bastion 数据库恢复技术手册

## 📚 手册目的

本手册基于2025年7月19日Bastion数据库表结构成功恢复的实战经验编写，为运维团队提供标准化的数据库紧急恢复操作指南。

---

## 🎯 适用场景

### 主要适用情况
- 数据库表结构被误删
- 数据库架构损坏
- 系统迁移需要重建数据库
- 开发/测试环境快速搭建
- 灾难恢复场景

### 系统要求
- **数据库**: MySQL 5.7+ / 8.0+ (推荐8.0+)
- **存储引擎**: InnoDB
- **字符集**: utf8mb4
- **权限**: 需要数据库管理员权限

---

## 🔧 技术架构

### 核心组件架构

```
Bastion 数据库架构
├── 用户权限系统 (5张表)
│   ├── users (用户表)
│   ├── roles (角色表)
│   ├── permissions (权限表)
│   ├── user_roles (用户角色关联)
│   └── role_permissions (角色权限关联)
├── 资产管理系统 (4张表)
│   ├── asset_groups (资产分组-层级)
│   ├── assets (资产表)
│   ├── credentials (凭证表)
│   └── asset_credentials (资产凭证关联)
├── 审计日志系统 (4张表)
│   ├── login_logs (登录日志)
│   ├── operation_logs (操作日志)
│   ├── session_records (会话记录)
│   └── command_logs (命令日志)
├── 实时监控系统 (3张表)
│   ├── session_monitor_logs (监控日志)
│   ├── session_warnings (警告消息)
│   └── websocket_connections (连接日志)
└── 系统支持
    ├── audit_statistics (审计统计视图)
    └── CleanupAuditLogs (清理存储过程)
```

### 关键技术指标

| 指标 | 数值 | 说明 |
|------|------|------|
| 总表数量 | 17张 | 核心业务表 |
| 外键约束 | 20个 | 数据完整性保证 |
| 性能索引 | 39个 | 查询优化 |
| 字符集 | utf8mb4 | 完整Unicode支持 |
| 存储引擎 | InnoDB | 事务和外键支持 |

---

## 🚀 快速恢复流程

### 一键恢复 (推荐)

```bash
# 进入恢复目录
cd /path/to/bastion/recovery/

# 执行自动化恢复脚本
./quick_recovery.sh

# 按提示输入数据库连接信息
# 脚本将自动完成：备份→清理→恢复→验证
```

### 手动恢复流程

#### 第一步：环境准备
```bash
# 1. 测试数据库连接
mysql -h<hostname> -u<username> -p -e "SELECT VERSION();"

# 2. 检查目标数据库
mysql -h<hostname> -u<username> -p -e "SHOW DATABASES;" | grep bastion

# 3. 评估现有表结构
mysql -h<hostname> -u<username> -p bastion -e "SHOW TABLES;"
```

#### 第二步：数据备份
```bash
# 完整备份当前数据库
mysqldump -h<hostname> -u<username> -p bastion > backup_$(date +%Y%m%d_%H%M%S).sql

# 验证备份文件
ls -la backup_*.sql
```

#### 第三步：数据库清理
```bash
# 执行清理脚本
mysql -h<hostname> -u<username> -p bastion < cleanup_database.sql

# 或者重建数据库
mysql -h<hostname> -u<username> -p -e "DROP DATABASE bastion; CREATE DATABASE bastion CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

#### 第四步：结构恢复
```bash
# 执行恢复脚本
mysql -h<hostname> -u<username> -p bastion < database_structure_recovery.sql
```

#### 第五步：验证确认
```bash
# 执行验证脚本
mysql -h<hostname> -u<username> -p bastion < validate_database_structure.sql

# 检查关键指标
mysql -h<hostname> -u<username> -p bastion -e "
SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema='bastion';
SELECT username, status FROM users WHERE username = 'admin';
"
```

---

## 📋 详细操作手册

### 连接配置

#### 标准连接格式
```bash
# 基本连接
mysql -h<hostname> -P<port> -u<username> -p<password> <database>

# 示例
mysql -h10.0.0.7 -P3306 -uroot -ppassword123 bastion
```

#### 连接参数说明
| 参数 | 说明 | 示例 |
|------|------|------|
| -h | 数据库主机地址 | 10.0.0.7 |
| -P | 数据库端口 | 3306 |
| -u | 用户名 | root |
| -p | 密码 | password123 |
| database | 目标数据库名 | bastion |

### 脚本文件说明

#### 核心恢复脚本

**database_structure_recovery.sql** (27KB)
```sql
-- 主要内容
1. 环境设置和外键控制
2. 17张核心表创建
3. 外键约束定义
4. 性能索引创建
5. 默认数据初始化
6. 审计视图和存储过程
7. 验证统计查询
```

**validate_database_structure.sql** (11KB)
```sql
-- 验证维度
1. 表结构完整性检查
2. 外键约束验证
3. 索引完整性检查
4. 数据类型一致性
5. 默认数据验证
6. 关联关系检查
7. 存储引擎验证
8. 性能统计分析
9. 最终完整性汇总
```

#### 辅助工具脚本

**quick_recovery.sh** (7KB)
- 交互式恢复向导
- 自动环境检查
- 备份和恢复流程
- 错误处理和日志

**cleanup_database.sql**
- 安全的表删除顺序
- 外键约束处理
- 视图和存储过程清理

### 默认配置参考

#### 系统用户
```sql
-- 默认管理员
用户名: admin
密码: admin123 (⚠️ 生产环境必须修改)
邮箱: admin@bastion.local
状态: 启用 (status=1)
```

#### 角色权限映射
```sql
-- admin 角色 (系统管理员)
权限: all (所有权限)

-- operator 角色 (运维人员)  
权限: asset:read, asset:connect, session:read

-- auditor 角色 (审计员)
权限: audit:read, audit:monitor, login_logs:read, 
     operation_logs:read, session_records:read, command_logs:read
```

#### 资产分组结构
```sql
-- 默认分组层级
生产环境 (production)
├── Web服务器
├── 应用服务器  
└── 数据库服务器

测试环境 (test)
└── 测试服务器

开发环境 (dev)
└── 开发服务器

通用分组 (general)
```

---

## 🔍 故障排除指南

### 常见错误及解决方案

#### 1. 连接错误
```bash
ERROR 2003 (HY000): Can't connect to MySQL server
```
**解决方案**:
- 检查主机地址和端口
- 确认MySQL服务运行状态
- 验证网络连通性
- 检查防火墙设置

#### 2. 权限错误
```bash
ERROR 1045 (28000): Access denied for user
```
**解决方案**:
```sql
-- 检查用户权限
SHOW GRANTS FOR 'username'@'host';

-- 授予必要权限
GRANT ALL PRIVILEGES ON bastion.* TO 'username'@'%';
FLUSH PRIVILEGES;
```

#### 3. 外键约束错误
```bash
ERROR 1215 (HY000): Cannot add foreign key constraint
```
**解决方案**:
```sql
-- 临时禁用外键检查
SET FOREIGN_KEY_CHECKS = 0;
-- 执行恢复操作
-- 重新启用外键检查
SET FOREIGN_KEY_CHECKS = 1;
```

#### 4. 字符集问题
```bash
ERROR 1366 (HY000): Incorrect string value
```
**解决方案**:
```sql
-- 检查数据库字符集
SHOW CREATE DATABASE bastion;

-- 修改字符集
ALTER DATABASE bastion CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 5. 表已存在错误
```bash
ERROR 1050 (42S01): Table 'tablename' already exists
```
**解决方案**:
- 使用`IF NOT EXISTS`语法
- 或先删除现有表结构
- 检查脚本中的`DROP TABLE IF EXISTS`语句

### 验证失败处理

#### 表数量不匹配
```sql
-- 预期: 17张表
-- 实际检查
SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='bastion';

-- 如果数量不对，检查错误日志
-- 重新执行恢复脚本
```

#### 外键约束缺失
```sql
-- 预期: 20个外键
-- 实际检查
SELECT COUNT(*) FROM information_schema.KEY_COLUMN_USAGE 
WHERE TABLE_SCHEMA = 'bastion' AND REFERENCED_TABLE_NAME IS NOT NULL;

-- 单独执行外键创建语句
ALTER TABLE table_name ADD CONSTRAINT constraint_name FOREIGN KEY ...;
```

#### 默认数据缺失
```sql
-- 检查默认用户
SELECT username FROM users WHERE username = 'admin';

-- 如果不存在，单独插入
INSERT INTO users (username, password, email, status) VALUES 
('admin', '$2a$10$x/i8F9qXh.tmIbwkLROCyeQleavmD4t0qR2BBQJ2cs57DvwaLbTs.', 'admin@bastion.local', 1);
```

---

## ⚡ 性能优化建议

### 索引优化

#### 关键查询索引
```sql
-- 用户查询优化
CREATE INDEX idx_users_username_status ON users(username, status);

-- 会话查询优化  
CREATE INDEX idx_session_records_user_time ON session_records(user_id, start_time);

-- 审计日志查询优化
CREATE INDEX idx_operation_logs_user_time ON operation_logs(user_id, created_at);
CREATE INDEX idx_command_logs_session_time ON command_logs(session_id, start_time);
```

#### 复合索引设计原则
1. **高选择性字段在前**: 区分度高的字段放在索引前面
2. **查询频率优先**: 常用查询条件组合
3. **覆盖索引**: 包含查询所需的所有字段
4. **避免冗余**: 不要创建重复的索引

### 查询优化

#### 分页查询优化
```sql
-- 避免深分页的OFFSET
-- 不推荐
SELECT * FROM operation_logs ORDER BY created_at DESC LIMIT 1000, 20;

-- 推荐使用游标分页
SELECT * FROM operation_logs 
WHERE created_at < '2025-07-19 00:00:00' 
ORDER BY created_at DESC LIMIT 20;
```

#### 时间范围查询优化
```sql
-- 使用索引友好的时间查询
SELECT * FROM login_logs 
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
  AND created_at < NOW()
ORDER BY created_at DESC;
```

### 存储优化

#### 表分区策略
```sql
-- 大表按时间分区 (适用于日志表)
ALTER TABLE operation_logs PARTITION BY RANGE (YEAR(created_at)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 数据清理策略
```sql
-- 使用存储过程定期清理
CALL CleanupAuditLogs(90); -- 清理90天前的日志

-- 或者定期归档
CREATE TABLE operation_logs_archive LIKE operation_logs;
INSERT INTO operation_logs_archive SELECT * FROM operation_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);
DELETE FROM operation_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

---

## 🛡️ 安全加固指南

### 密码安全

#### 修改默认密码
```sql
-- 生成新的bcrypt密码哈希
-- 使用外部工具生成，例如:
-- echo -n "new_password" | bcrypt

-- 更新管理员密码
UPDATE users SET password = '$2a$10$新的bcrypt哈希值' WHERE username = 'admin';
```

#### 密码策略
```sql
-- 建议的密码策略
1. 最小长度: 8位
2. 包含大小写字母
3. 包含数字和特殊字符
4. 定期更换 (90天)
5. 禁止重用最近5个密码
```

### 权限控制

#### 用户权限审计
```sql
-- 查看所有用户权限
SELECT 
    u.username,
    r.name as role_name,
    p.name as permission_name,
    p.category
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
JOIN role_permissions rp ON r.id = rp.role_id
JOIN permissions p ON rp.permission_id = p.id
ORDER BY u.username, r.name;
```

#### 权限最小化原则
```sql
-- 为不同角色分配最小必要权限
-- 普通用户只给基本权限
-- 管理员权限分级管理
-- 定期审核权限使用情况
```

### 访问控制

#### 数据库访问限制
```sql
-- 限制数据库用户访问范围
CREATE USER 'bastion_app'@'app_server_ip' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON bastion.* TO 'bastion_app'@'app_server_ip';

-- 限制管理用户访问
GRANT ALL PRIVILEGES ON bastion.* TO 'admin'@'admin_ip' IDENTIFIED BY 'admin_password';
```

#### 审计日志监控
```sql
-- 监控高危操作
SELECT * FROM operation_logs 
WHERE action IN ('delete', 'update') 
  AND resource IN ('user', 'role', 'permission')
  AND created_at > DATE_SUB(NOW(), INTERVAL 1 DAY);

-- 监控异常登录
SELECT * FROM login_logs 
WHERE status = 'failed' 
  AND created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY ip 
HAVING COUNT(*) > 5;
```

---

## 📊 监控和维护

### 关键监控指标

#### 系统健康指标
```sql
-- 活跃用户数
SELECT COUNT(*) as active_users FROM users WHERE status = 1;

-- 活跃会话数
SELECT COUNT(*) as active_sessions FROM session_records WHERE status = 'active';

-- 今日操作数
SELECT COUNT(*) as today_operations FROM operation_logs WHERE DATE(created_at) = CURDATE();
```

#### 性能指标
```sql
-- 查询性能统计
SELECT 
    TABLE_NAME,
    TABLE_ROWS,
    ROUND(DATA_LENGTH/1024/1024, 2) as data_size_mb,
    ROUND(INDEX_LENGTH/1024/1024, 2) as index_size_mb
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'bastion'
ORDER BY DATA_LENGTH DESC;
```

#### 安全指标
```sql
-- 登录失败统计
SELECT 
    DATE(created_at) as date,
    COUNT(*) as failed_logins
FROM login_logs 
WHERE status = 'failed' 
  AND created_at > DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(created_at);

-- 高危命令统计
SELECT 
    DATE(created_at) as date,
    COUNT(*) as high_risk_commands
FROM command_logs 
WHERE risk = 'high' 
  AND created_at > DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(created_at);
```

### 定期维护任务

#### 每日任务
```bash
#!/bin/bash
# 每日维护脚本

# 1. 数据库备份
mysqldump -uroot -p bastion > daily_backup_$(date +%Y%m%d).sql

# 2. 检查表完整性
mysql -uroot -p bastion -e "CHECK TABLE users, roles, permissions;"

# 3. 更新表统计
mysql -uroot -p bastion -e "ANALYZE TABLE login_logs, operation_logs, session_records;"
```

#### 每周任务
```bash
#!/bin/bash
# 每周维护脚本

# 1. 清理7天前的临时数据
mysql -uroot -p bastion -e "DELETE FROM websocket_connections WHERE connect_time < DATE_SUB(NOW(), INTERVAL 7 DAY);"

# 2. 优化表结构
mysql -uroot -p bastion -e "OPTIMIZE TABLE login_logs, operation_logs;"

# 3. 检查慢查询
# 分析 slow query log
```

#### 每月任务
```bash
#!/bin/bash
# 每月维护脚本

# 1. 清理审计日志
mysql -uroot -p bastion -e "CALL CleanupAuditLogs(90);"

# 2. 权限审计
mysql -uroot -p bastion < monthly_permission_audit.sql

# 3. 性能报告
mysql -uroot -p bastion < monthly_performance_report.sql
```

---

## 🚨 应急响应流程

### 故障分级

#### P0 - 紧急故障
- 数据库完全不可访问
- 核心表结构损坏
- 数据大量丢失

**响应时间**: 15分钟内  
**处理流程**: 立即启动应急恢复

#### P1 - 严重故障  
- 部分功能不可用
- 性能严重下降
- 安全事件

**响应时间**: 1小时内  
**处理流程**: 快速诊断和修复

#### P2 - 一般故障
- 个别功能异常
- 性能轻微影响
- 数据一致性问题

**响应时间**: 4小时内  
**处理流程**: 计划修复

### 应急处理步骤

#### 第一步：问题确认 (5分钟)
```bash
# 1. 连接测试
mysql -h<host> -u<user> -p -e "SELECT 1;"

# 2. 基础检查
mysql -h<host> -u<user> -p bastion -e "SHOW TABLES;"

# 3. 关键数据验证
mysql -h<host> -u<user> -p bastion -e "SELECT COUNT(*) FROM users;"
```

#### 第二步：影响评估 (10分钟)
```bash
# 1. 检查受影响的表
mysql -h<host> -u<user> -p bastion -e "
SELECT TABLE_NAME, TABLE_ROWS 
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'bastion';
"

# 2. 检查外键完整性
mysql -h<host> -u<user> -p bastion -e "
SELECT COUNT(*) FROM information_schema.KEY_COLUMN_USAGE 
WHERE TABLE_SCHEMA = 'bastion' AND REFERENCED_TABLE_NAME IS NOT NULL;
"

# 3. 检查关键功能
mysql -h<host> -u<user> -p bastion -e "SELECT username FROM users WHERE username = 'admin';"
```

#### 第三步：备份当前状态 (5分钟)
```bash
# 紧急备份 (即使结构不完整也要备份)
mysqldump -h<host> -u<user> -p bastion > emergency_backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 第四步：执行恢复 (10分钟)
```bash
# 使用快速恢复脚本
cd /path/to/bastion/recovery/
./quick_recovery.sh

# 或手动恢复
mysql -h<host> -u<user> -p bastion < database_structure_recovery.sql
```

#### 第五步：验证恢复 (5分钟)
```bash
# 执行验证脚本
mysql -h<host> -u<user> -p bastion < validate_database_structure.sql

# 检查关键指标
mysql -h<host> -u<user> -p bastion -e "
SELECT 
  (SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='bastion') as tables,
  (SELECT COUNT(*) FROM users) as users,
  (SELECT COUNT(*) FROM roles) as roles;
"
```

---

## 📞 联系信息和资源

### 技术支持联系

#### 内部团队
- **DBA团队**: 数据库相关问题
- **开发团队**: 应用逻辑问题  
- **运维团队**: 基础设施问题
- **安全团队**: 安全事件响应

#### 外部资源
- **MySQL官方文档**: https://dev.mysql.com/doc/
- **GORM文档**: https://gorm.io/docs/
- **项目Issue**: 项目仓库Issues页面

### 相关文档链接

#### 项目文档
- **API文档**: `/docs/api/`
- **部署指南**: `/docs/deployment/`
- **用户手册**: `/docs/user-guide/`

#### 恢复工具
- **恢复脚本**: `/recovery/database_structure_recovery.sql`
- **验证脚本**: `/recovery/validate_database_structure.sql`
- **自动化工具**: `/recovery/quick_recovery.sh`

---

## 📋 附录

### A. 完整表结构清单

| 表名 | 说明 | 主要字段 | 关联关系 |
|------|------|----------|----------|
| users | 用户表 | id, username, password, email, status | → user_roles |
| roles | 角色表 | id, name, description | → role_permissions |
| permissions | 权限表 | id, name, category | ← role_permissions |
| user_roles | 用户角色关联 | user_id, role_id | users ↔ roles |
| role_permissions | 角色权限关联 | role_id, permission_id | roles ↔ permissions |
| asset_groups | 资产分组 | id, name, parent_id, type | ← assets |
| assets | 资产表 | id, name, address, port, group_id | → asset_credentials |
| credentials | 凭证表 | id, name, type, username, password | → asset_credentials |
| asset_credentials | 资产凭证关联 | asset_id, credential_id | assets ↔ credentials |
| login_logs | 登录日志 | id, user_id, ip, status, created_at | → users |
| operation_logs | 操作日志 | id, user_id, action, resource, created_at | → users |
| session_records | 会话记录 | id, session_id, user_id, asset_id, status | → users, assets |
| command_logs | 命令日志 | id, session_id, user_id, command, risk | → users, assets |
| session_monitor_logs | 监控日志 | id, session_id, monitor_user_id, action_type | → users |
| session_warnings | 警告消息 | id, session_id, sender_user_id, receiver_user_id | → users |
| websocket_connections | 连接日志 | id, client_id, user_id, connect_time | → users |

### B. 权限列表清单

| 权限名称 | 分类 | 说明 |
|----------|------|------|
| user:create | user | 创建用户 |
| user:read | user | 查看用户 |
| user:update | user | 更新用户 |
| user:delete | user | 删除用户 |
| role:create | role | 创建角色 |
| role:read | role | 查看角色 |
| role:update | role | 更新角色 |
| role:delete | role | 删除角色 |
| asset:create | asset | 创建资产 |
| asset:read | asset | 查看资产 |
| asset:update | asset | 更新资产 |
| asset:delete | asset | 删除资产 |
| asset:connect | asset | 连接资产 |
| audit:read | audit | 查看审计日志 |
| audit:cleanup | audit | 清理审计日志 |
| audit:monitor | audit | 实时监控权限 |
| audit:terminate | audit | 会话终止权限 |
| audit:warning | audit | 发送警告权限 |
| login_logs:read | audit | 查看登录日志 |
| operation_logs:read | audit | 查看操作日志 |
| session_records:read | audit | 查看会话记录 |
| command_logs:read | audit | 查看命令日志 |
| session:read | session | 查看会话 |
| log:read | log | 查看日志 |
| all | system | 所有权限 |

### C. 常用SQL查询模板

#### 用户管理查询
```sql
-- 查看用户及其角色
SELECT u.username, r.name as role_name, u.status
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
ORDER BY u.username;

-- 查看角色及其权限
SELECT r.name as role_name, p.name as permission_name, p.category
FROM roles r
LEFT JOIN role_permissions rp ON r.id = rp.role_id
LEFT JOIN permissions p ON rp.permission_id = p.id
ORDER BY r.name, p.category;
```

#### 资产管理查询
```sql
-- 查看资产分组结构
SELECT 
    ag.id,
    ag.name,
    parent.name as parent_name,
    COUNT(a.id) as asset_count
FROM asset_groups ag
LEFT JOIN asset_groups parent ON ag.parent_id = parent.id
LEFT JOIN assets a ON ag.id = a.group_id
GROUP BY ag.id, ag.name, parent.name
ORDER BY ag.parent_id, ag.sort_order;

-- 查看资产及其凭证
SELECT 
    a.name as asset_name,
    a.address,
    a.port,
    c.name as credential_name,
    c.type as credential_type
FROM assets a
LEFT JOIN asset_credentials ac ON a.id = ac.asset_id
LEFT JOIN credentials c ON ac.credential_id = c.id
ORDER BY a.name;
```

#### 审计日志查询
```sql
-- 今日登录统计
SELECT 
    status,
    COUNT(*) as count
FROM login_logs 
WHERE DATE(created_at) = CURDATE()
GROUP BY status;

-- 最近会话记录
SELECT 
    sr.session_id,
    u.username,
    a.name as asset_name,
    sr.status,
    sr.start_time,
    sr.end_time
FROM session_records sr
JOIN users u ON sr.user_id = u.id
JOIN assets a ON sr.asset_id = a.id
WHERE sr.start_time > DATE_SUB(NOW(), INTERVAL 24 HOUR)
ORDER BY sr.start_time DESC;
```

---

**📄 手册版本**: v1.0  
**📅 创建时间**: 2025-07-19  
**✍️ 编写团队**: Bastion运维团队  
**🔄 最后更新**: 2025-07-19  
**📞 维护联系**: 项目运维团队  

*本技术手册基于实战恢复经验编写，建议定期更新和完善。*