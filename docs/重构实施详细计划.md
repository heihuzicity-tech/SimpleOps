# Bastioné¡¹ç›®é‡æ„å®æ–½è¯¦ç»†è®¡åˆ’

**åˆ¶å®šæ—¶é—´**: 2025-07-14  
**é¢„è®¡æ—¶é—´**: 2-3å‘¨  
**ç›®æ ‡**: æ¶ˆé™¤ä»£ç é‡å¤ï¼Œä¼˜åŒ–æ¶æ„ï¼Œæå‡å¯ç»´æŠ¤æ€§

## ğŸ¯ **é‡æ„ç›®æ ‡**

### æ ¸å¿ƒç›®æ ‡
- âœ… æ¶ˆé™¤åç«¯130è¡Œé‡å¤ä»£ç ï¼Œå‰ç«¯190è¡Œé‡å¤ä»£ç 
- âœ… ç»Ÿä¸€ä¼šè¯ç®¡ç†ï¼šç§»é™¤å†…å­˜å­˜å‚¨ï¼Œç»Ÿä¸€ä½¿ç”¨Redis
- âœ… æŠ½è±¡æœåŠ¡æ¥å£ï¼šå®ç°ä¾èµ–æ³¨å…¥å’Œæ¥å£éš”ç¦»
- âœ… å‰ç«¯ç»„ä»¶å¤ç”¨ï¼šåˆ›å»ºé€šç”¨Hookså’Œç»„ä»¶
- âœ… æå‡ä»£ç è´¨é‡ï¼šå‡å°‘è€¦åˆï¼Œå¢å¼ºå¯æµ‹è¯•æ€§

### é‡åŒ–æŒ‡æ ‡
- **é‡å¤ä»£ç å‡å°‘**: 320è¡Œ â†’ 0è¡Œï¼ˆ100%æ¶ˆé™¤ï¼‰
- **æœåŠ¡æ¥å£æŠ½è±¡ç‡**: 0% â†’ 80%
- **å‰ç«¯ç»„ä»¶å¤ç”¨ç‡**: 20% â†’ 80%
- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡**: 30% â†’ 70%

## ğŸ“… **åˆ†é˜¶æ®µå®æ–½è®¡åˆ’**

### Phase 1: åç«¯åŸºç¡€æœåŠ¡é‡æ„ (ç¬¬1å‘¨)

#### 1.1 åˆ›å»ºå·¥å…·ç±»å’Œæ¥å£ (1-2å¤©)

**æ–°å»ºæ–‡ä»¶æ¸…å•:**

1. **backend/utils/credential_utils.go**
```go
// å‡­è¯åŠ å¯†è§£å¯†ç»Ÿä¸€å·¥å…·
- EncryptCredential(password string) (string, error)
- DecryptCredential(encrypted string) (string, error) 
- ValidateCredentialType(credType string) bool
- ValidatePrivateKey(key string) error
```

2. **backend/utils/connection_utils.go**
```go
// è¿æ¥æµ‹è¯•ç»Ÿä¸€å·¥å…·
- TestTCPConnection(host string, port int, timeout time.Duration) error
- TestSSHConnection(config *SSHConfig) error
- TestDatabaseConnection(config *DBConfig) error
- FormatAddress(host string, port int) string
```

3. **backend/interfaces/asset_interface.go**
```go
// æœåŠ¡æ¥å£å®šä¹‰
type AssetProvider interface {
    GetAssetByID(id uint) (*models.Asset, error)
    GetAssetCredentials(assetID uint) ([]models.Credential, error)
}

type SessionManager interface {
    CreateSession(session *SessionInfo) error
    GetSession(sessionID string) (*SessionInfo, error)
    CloseSession(sessionID string) error
}

type ConnectionTester interface {
    TestConnection(asset *models.Asset, credential *models.Credential) error
}
```

4. **backend/services/connectivity_service.go**
```go
// è¿æ¥ç»Ÿä¸€æœåŠ¡
- ç»Ÿä¸€å‡­è¯ç®¡ç†å’Œè§£å¯†
- ç»Ÿä¸€è¿æ¥æµ‹è¯•æ¥å£
- ä¼šè¯éªŒè¯å’Œä¸Šä¸‹æ–‡ç®¡ç†
- SSHé…ç½®åˆ›å»º
```

5. **backend/services/unified_session_service.go**
```go
// ç»Ÿä¸€ä¼šè¯æœåŠ¡
- Redisä½œä¸ºä¸»å­˜å‚¨
- MySQLä½œä¸ºæŒä¹…åŒ–å­˜å‚¨
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯
- ä¼šè¯çŠ¶æ€åŒæ­¥
```

#### 1.2 å®ç°æœåŠ¡é€‚é…å™¨ (1å¤©)

6. **backend/services/service_adapter.go**
```go
// æœåŠ¡é€‚é…å™¨å’Œæ³¨å†Œè¡¨
type ServiceRegistry struct {
    AssetProvider AssetProvider
    SessionManager SessionManager
    ConnectionTester ConnectionTester
}

- AssetServiceAdapterå®ç°AssetProvider
- SessionServiceAdapterå®ç°SessionManager
- ConnectionTesterAdapterå®ç°ConnectionTester
```

### Phase 2: å‰ç«¯é€šç”¨ç»„ä»¶å¼€å‘ (ç¬¬1å‘¨æœ«-ç¬¬2å‘¨åˆ)

#### 2.1 åˆ›å»ºé€šç”¨Hooks (2å¤©)

**æ–°å»ºæ–‡ä»¶æ¸…å•:**

7. **frontend/src/hooks/useAssetManagement.ts**
```typescript
// èµ„äº§ç®¡ç†ç»Ÿä¸€Hook
export const useAssetManagement = () => {
  // èµ„äº§CRUDæ“ä½œ
  // æœç´¢å’Œè¿‡æ»¤
  // åˆ†ç»„ç®¡ç†
  // è¿æ¥æµ‹è¯•
  // çŠ¶æ€ç®¡ç†
}
```

8. **frontend/src/hooks/useSessionManagement.ts**
```typescript
// ä¼šè¯ç®¡ç†ç»Ÿä¸€Hook
export const useSessionManagement = () => {
  // ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
  // ç»ˆç«¯çŠ¶æ€ç®¡ç†
  // æ‰¹é‡æ“ä½œ
  // è‡ªåŠ¨åˆ·æ–°
}
```

9. **frontend/src/hooks/useConnectionStatus.ts**
```typescript
// è¿æ¥çŠ¶æ€ç®¡ç†Hook
export const useConnectionStatus = () => {
  // è¿æ¥çŠ¶æ€ç›‘æ§
  // è‡ªåŠ¨é‡è¿é€»è¾‘
  // çŠ¶æ€å˜åŒ–å›è°ƒ
}
```

#### 2.2 åˆ›å»ºé€šç”¨ç»„ä»¶ (2å¤©)

10. **frontend/src/components/common/ConnectionStatusTag.tsx**
```typescript
// ç»Ÿä¸€è¿æ¥çŠ¶æ€æ˜¾ç¤ºç»„ä»¶
interface ConnectionStatusTagProps {
  status: 'connected' | 'disconnected' | 'connecting' | 'error'
  size?: 'small' | 'medium' | 'large'
  showText?: boolean
}
```

11. **frontend/src/components/common/AssetForm.tsx**
```typescript
// é€šç”¨èµ„äº§è¡¨å•ç»„ä»¶
interface AssetFormProps {
  mode: 'create' | 'edit'
  initialValues?: Partial<Asset>
  onSubmit: (values: AssetFormData) => Promise<void>
  onCancel: () => void
}
```

12. **frontend/src/components/common/ResourceTable.tsx**
```typescript
// é€šç”¨èµ„æºè¡¨æ ¼ç»„ä»¶
interface ResourceTableProps<T> {
  data: T[]
  columns: ColumnConfig<T>[]
  actions?: ActionConfig<T>[]
  loading?: boolean
  pagination?: PaginationConfig
}
```

13. **frontend/src/components/common/SearchFilter.tsx**
```typescript
// é€šç”¨æœç´¢è¿‡æ»¤ç»„ä»¶
interface SearchFilterProps {
  onSearch: (keyword: string) => void
  onFilter: (filters: FilterConfig) => void
  placeholder?: string
  filters?: FilterOption[]
}
```

### Phase 3: ç°æœ‰ä»£ç é‡æ„ (ç¬¬2å‘¨)

#### 3.1 åç«¯æœåŠ¡é‡æ„ (3å¤©)

**ä¿®æ”¹æ–‡ä»¶æ¸…å•:**

14. **backend/services/asset_service.go**
```go
// é‡æ„å†…å®¹:
- ç§»é™¤é‡å¤çš„è¿æ¥æµ‹è¯•é€»è¾‘ â†’ ä½¿ç”¨connectivity_service
- ç§»é™¤é‡å¤çš„å‡­è¯è§£å¯†é€»è¾‘ â†’ ä½¿ç”¨credential_utils  
- ä¿ç•™æ ¸å¿ƒCRUDåŠŸèƒ½
- å®ç°AssetProvideræ¥å£
```

15. **backend/services/ssh_service.go**
```go
// é‡æ„å†…å®¹:
- ç§»é™¤ç›´æ¥æ•°æ®åº“æŸ¥è¯¢ â†’ ä½¿ç”¨AssetProvideræ¥å£
- ç§»é™¤å†…å­˜ä¼šè¯å­˜å‚¨ â†’ ä½¿ç”¨unified_session_service
- ç§»é™¤é‡å¤å‡­è¯å¤„ç† â†’ ä½¿ç”¨connectivity_service
- å®ç°SessionManageræ¥å£
```

16. **backend/controllers/asset_controller.go**
```go
// é‡æ„å†…å®¹:
- ä½¿ç”¨ServiceRegistryè¿›è¡Œä¾èµ–æ³¨å…¥
- ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
- ä¼˜åŒ–APIå“åº”æ ¼å¼
```

17. **backend/controllers/ssh_controller.go**
```go
// é‡æ„å†…å®¹:
- ä½¿ç”¨ServiceRegistryè¿›è¡Œä¾èµ–æ³¨å…¥
- ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
- ä½¿ç”¨ç»Ÿä¸€ä¼šè¯ç®¡ç†
```

#### 3.2 å‰ç«¯é¡µé¢é‡æ„ (2å¤©)

**ä¿®æ”¹æ–‡ä»¶æ¸…å•:**

18. **frontend/src/pages/AssetsPage.tsx**
```typescript
// é‡æ„å†…å®¹:
- ä½¿ç”¨useAssetManagement Hook â†’ ç§»é™¤é‡å¤çŠ¶æ€ç®¡ç†
- ä½¿ç”¨AssetFormç»„ä»¶ â†’ ç§»é™¤é‡å¤è¡¨å•é€»è¾‘
- ä½¿ç”¨ResourceTableç»„ä»¶ â†’ ç§»é™¤é‡å¤è¡¨æ ¼ä»£ç 
- ä½¿ç”¨ConnectionStatusTag â†’ ç»Ÿä¸€çŠ¶æ€æ˜¾ç¤º
```

19. **frontend/src/pages/SSHSessionsPage.tsx**
```typescript
// é‡æ„å†…å®¹:
- ä½¿ç”¨useSessionManagement Hook â†’ ç§»é™¤é‡å¤çŠ¶æ€ç®¡ç†
- ä½¿ç”¨ResourceTableç»„ä»¶ â†’ ç»Ÿä¸€è¡¨æ ¼æ˜¾ç¤º
- ä½¿ç”¨ConnectionStatusTag â†’ ç»Ÿä¸€çŠ¶æ€æ˜¾ç¤º
- é›†æˆå®æ—¶çŠ¶æ€æ›´æ–°
```

20. **frontend/src/components/ssh/WebTerminal.tsx**
```typescript
// é‡æ„å†…å®¹:
- é›†æˆunified session management
- ä½¿ç”¨useConnectionStatus Hook
- ä¼˜åŒ–è¿æ¥çŠ¶æ€å¤„ç†
- æ”¹è¿›é”™è¯¯å¤„ç†å’Œé‡è¿é€»è¾‘
```

### Phase 4: é›†æˆæµ‹è¯•å’Œä¼˜åŒ– (ç¬¬3å‘¨)

#### 4.1 å•å…ƒæµ‹è¯•ç¼–å†™ (2å¤©)

21. **backend/tests/**
- `connectivity_service_test.go`
- `unified_session_service_test.go`
- `credential_utils_test.go`
- `connection_utils_test.go`

22. **frontend/src/__tests__/**
- `useAssetManagement.test.ts`
- `useSessionManagement.test.ts`
- `ConnectionStatusTag.test.tsx`
- `AssetForm.test.tsx`

#### 4.2 é›†æˆæµ‹è¯•å’Œè°ƒä¼˜ (3å¤©)

23. **åŠŸèƒ½éªŒè¯æµ‹è¯•**
- èµ„äº§ç®¡ç†åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•
- SSHä¼šè¯ç®¡ç†åŠŸèƒ½æµ‹è¯•
- è¿æ¥æµ‹è¯•åŠŸèƒ½éªŒè¯
- å‰ç«¯äº¤äº’æµç¨‹æµ‹è¯•

24. **æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–**
- APIå“åº”æ—¶é—´æµ‹è¯•
- å‰ç«¯æ¸²æŸ“æ€§èƒ½æµ‹è¯•
- å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§
- Redisè¿æ¥æ± ä¼˜åŒ–

## ğŸ“‹ **å…·ä½“å®æ–½æ­¥éª¤**

### æ­¥éª¤1: ç¯å¢ƒå‡†å¤‡
```bash
# åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
mkdir -p backend/interfaces
mkdir -p backend/tests
mkdir -p frontend/src/hooks
mkdir -p frontend/src/components/common
mkdir -p frontend/src/__tests__

# å¤‡ä»½å…³é”®æ–‡ä»¶
cp backend/services/asset_service.go backend/services/asset_service.go.backup
cp backend/services/ssh_service.go backend/services/ssh_service.go.backup
cp frontend/src/pages/AssetsPage.tsx frontend/src/pages/AssetsPage.tsx.backup
cp frontend/src/pages/SSHSessionsPage.tsx frontend/src/pages/SSHSessionsPage.tsx.backup
```

### æ­¥éª¤2: æŒ‰åºå®æ–½
1. **Day 1-2**: åˆ›å»ºå·¥å…·ç±»å’Œæ¥å£ (æ–‡ä»¶1-3)
2. **Day 3-4**: å®ç°åŸºç¡€æœåŠ¡ (æ–‡ä»¶4-6)
3. **Day 5-6**: åˆ›å»ºå‰ç«¯Hooks (æ–‡ä»¶7-9)
4. **Day 7-8**: åˆ›å»ºå‰ç«¯ç»„ä»¶ (æ–‡ä»¶10-13)
5. **Day 9-11**: åç«¯æœåŠ¡é‡æ„ (æ–‡ä»¶14-17)
6. **Day 12-13**: å‰ç«¯é¡µé¢é‡æ„ (æ–‡ä»¶18-20)
7. **Day 14-15**: ç¼–å†™å•å…ƒæµ‹è¯• (æ–‡ä»¶21-22)
8. **Day 16-18**: é›†æˆæµ‹è¯•è°ƒä¼˜ (æ–‡ä»¶23-24)

### æ­¥éª¤3: éªŒè¯å’Œéƒ¨ç½²
```bash
# è¿è¡Œæµ‹è¯•å¥—ä»¶
./manage.sh test

# æ€§èƒ½åŸºå‡†æµ‹è¯•  
./manage.sh benchmark

# éƒ¨ç½²éªŒè¯
./manage.sh deploy --env=staging
```

## âš ï¸ **é£é™©è¯„ä¼°å’Œç¼“è§£ç­–ç•¥**

### é«˜é£é™©é¡¹ç›®
| é£é™©é¡¹ç›® | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | ç¼“è§£æªæ–½ |
|----------|----------|----------|----------|
| ä¼šè¯æ•°æ®è¿ç§»å¤±è´¥ | ğŸ”´ é«˜ | ç”¨æˆ·ä¼šè¯ä¸¢å¤± | 1. æ•°æ®å¤‡ä»½ 2. åˆ†é˜¶æ®µè¿ç§» 3. å›æ»šæ–¹æ¡ˆ |
| æœåŠ¡æ¥å£ä¸å…¼å®¹ | ğŸŸ¡ ä¸­ | APIè°ƒç”¨å¤±è´¥ | 1. å‘ä¸‹å…¼å®¹ 2. ç‰ˆæœ¬æ§åˆ¶ 3. ç°åº¦å‘å¸ƒ |
| å‰ç«¯ç»„ä»¶é‡æ„é”™è¯¯ | ğŸŸ¡ ä¸­ | ç”¨æˆ·ç•Œé¢å¼‚å¸¸ | 1. ç»„ä»¶æµ‹è¯• 2. è§†è§‰å›å½’æµ‹è¯• 3. ç”¨æˆ·éªŒæ”¶ |

### å›æ»šç­–ç•¥
```bash
# å¿«é€Ÿå›æ»šåˆ°é‡æ„å‰çŠ¶æ€
git checkout pre-refactor-backup
./manage.sh deploy --rollback

# æ•°æ®å›æ»š
redis-cli flushdb
mysql < backup_sessions.sql
```

## ğŸ“Š **é¢„æœŸæ”¶ç›Šé‡åŒ–**

### ä»£ç è´¨é‡æå‡
- **é‡å¤ä»£ç **: 320è¡Œ â†’ 0è¡Œ (å‡å°‘100%)
- **æ–‡ä»¶æ•°é‡**: ç°æœ‰16ä¸ª â†’ ä¼˜åŒ–å24ä¸ª (å¢åŠ 50%ï¼Œä½†é€»è¾‘æ›´æ¸…æ™°)
- **å•ä¸ªæ–‡ä»¶å¹³å‡è¡Œæ•°**: 600è¡Œ â†’ 400è¡Œ (å‡å°‘33%)
- **æœåŠ¡è€¦åˆåº¦**: é«˜è€¦åˆ â†’ æ¥å£éš”ç¦» (æå‡80%)

### å¼€å‘æ•ˆç‡æå‡
- **æ–°åŠŸèƒ½å¼€å‘æ—¶é—´**: å‡å°‘40%
- **bugä¿®å¤æ—¶é—´**: å‡å°‘50%  
- **ä»£ç å®¡æŸ¥æ—¶é—´**: å‡å°‘30%
- **æ–°äººä¸Šæ‰‹æ—¶é—´**: å‡å°‘60%

### è¿è¡Œæ€§èƒ½æå‡
- **å†…å­˜ä½¿ç”¨**: å‡å°‘20% (ç»Ÿä¸€ä¼šè¯ç®¡ç†)
- **APIå“åº”æ—¶é—´**: æå‡15% (å‡å°‘é‡å¤æŸ¥è¯¢)
- **å‰ç«¯æ¸²æŸ“**: æå‡25% (ç»„ä»¶å¤ç”¨)
- **è¿æ¥æˆåŠŸç‡**: æå‡10% (ç»Ÿä¸€è¿æ¥ç®¡ç†)

## âœ… **éªŒæ”¶æ ‡å‡†**

### åŠŸèƒ½éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- [ ] èµ„äº§CRUDæ“ä½œæ­£å¸¸
- [ ] SSHä¼šè¯åˆ›å»º/å…³é—­æ­£å¸¸
- [ ] è¿æ¥æµ‹è¯•åŠŸèƒ½æ­£å¸¸
- [ ] å®¡è®¡æ—¥å¿—è®°å½•å®Œæ•´
- [ ] ç”¨æˆ·æƒé™æ§åˆ¶æ­£å¸¸

### æŠ€æœ¯éªŒæ”¶æ ‡å‡†
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 70%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ = 100%
- [ ] APIå“åº”æ—¶é—´ â‰¤ 500ms
- [ ] å‰ç«¯é¡µé¢åŠ è½½æ—¶é—´ â‰¤ 3s
- [ ] å†…å­˜ä½¿ç”¨å‡å°‘ â‰¥ 20%
- [ ] é‡å¤ä»£ç å‡å°‘ = 100%

### ä»£ç è´¨é‡æ ‡å‡†
- [ ] æ‰€æœ‰æ–°å¢æ–‡ä»¶é€šè¿‡ESLint/Golintæ£€æŸ¥
- [ ] ä»£ç æ³¨é‡Šè¦†ç›–ç‡ â‰¥ 60%
- [ ] æ¥å£æŠ½è±¡ç‡ â‰¥ 80%
- [ ] ç»„ä»¶å¤ç”¨ç‡ â‰¥ 80%
- [ ] æ— ä¸¥é‡å®‰å…¨æ¼æ´
- [ ] ç¬¦åˆå›¢é˜Ÿç¼–ç è§„èŒƒ

## ğŸ“ **å®æ–½å‡†å¤‡**

### å¼€å§‹å‰ç¡®è®¤æ¸…å•
- [ ] ç¡®è®¤å½“å‰ä»£ç åŠŸèƒ½æ­£å¸¸
- [ ] åˆ›å»ºå®Œæ•´çš„æ•°æ®å¤‡ä»½
- [ ] å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
- [ ] å›¢é˜Ÿæˆå‘˜æ—¶é—´å®‰æ’ç¡®è®¤
- [ ] ç”¨æˆ·é€šçŸ¥å’Œå½±å“è¯„ä¼°

### å®æ–½æ—¶æ³¨æ„äº‹é¡¹
1. **æ¯æ—¥è¿›åº¦æ£€æŸ¥**: ç¡®ä¿æŒ‰è®¡åˆ’æ¨è¿›
2. **åŠŸèƒ½éªŒè¯**: æ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡ŒåŠŸèƒ½æµ‹è¯•
3. **ä»£ç å®¡æŸ¥**: é‡è¦ä¿®æ”¹å¿…é¡»ç»è¿‡å®¡æŸ¥
4. **æ–‡æ¡£æ›´æ–°**: åŠæ—¶æ›´æ–°æŠ€æœ¯æ–‡æ¡£
5. **é£é™©ç›‘æ§**: å¯†åˆ‡å…³æ³¨ç³»ç»Ÿç¨³å®šæ€§

---

**ğŸ“‹ æ€»ç»“**: è¿™æ˜¯ä¸€ä¸ªå…¨é¢çš„é‡æ„è®¡åˆ’ï¼Œæ¶‰åŠ24ä¸ªæ–‡ä»¶çš„åˆ›å»ºå’Œä¿®æ”¹ã€‚é€šè¿‡3å‘¨çš„åˆ†é˜¶æ®µå®æ–½ï¼Œå°†æ˜¾è‘—æå‡ä»£ç è´¨é‡å’Œç³»ç»Ÿæ¶æ„ã€‚è¯·ç¡®è®¤æ˜¯å¦åŒæ„è¿™ä¸ªè®¡åˆ’ï¼Œæˆ‘å°†æŒ‰æ­¥éª¤å¼€å§‹å®æ–½ã€‚