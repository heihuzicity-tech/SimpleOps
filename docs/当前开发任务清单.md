# Bastion 当前开发任务清单

**更新时间**: 2025-07-15  
**任务优先级**: 按重要性和紧急性排序  
**项目状态**: 重构完成91.8%，准备进入下一阶段开发

---

## 🔥 立即开始任务 (本周内完成)

### 1. 修复关键安全漏洞 ⚠️ 高危
**任务**: 修复SSH连接安全配置
**位置**: `backend/services/ssh_service.go:156`
**问题**: 使用`ssh.InsecureIgnoreHostKey()`跳过主机密钥验证
**解决方案**:
```go
// 当前代码 (不安全)
HostKeyCallback: ssh.InsecureIgnoreHostKey()

// 修复后代码 (安全)
HostKeyCallback: ssh.FixedHostKey(hostKey) // 或实现动态主机密钥验证
```
**预计时间**: 1-2天
**验收标准**: 
- [ ] SSH连接使用正确的主机密钥验证
- [ ] 安全扫描通过
- [ ] 现有SSH连接功能正常

### 2. 完善登录日志界面 ⭐ 中优先级
**任务**: 创建专门的登录日志管理页面
**位置**: `frontend/src/components/audit/` 
**当前状态**: 后端API完整，前端缺少专用组件
**需要创建**:
```typescript
frontend/src/components/audit/LoginLogsTable.tsx
- 登录成功/失败状态区分显示
- IP地址信息展示
- 登录时间和用户代理显示
- 异常登录标识和过滤
```
**预计时间**: 2-3天
**验收标准**:
- [ ] 登录日志专用页面创建
- [ ] 集成到审计概览页面
- [ ] 支持搜索和过滤功能
- [ ] 异常登录高亮显示

### 3. 添加WebSocket连接超时控制 ⚠️ 中危
**任务**: 防止WebSocket连接内存泄漏
**位置**: `backend/services/websocket_service.go`
**问题**: WebSocket连接缺乏超时机制
**解决方案**:
```go
// 添加连接超时和心跳检测
conn.SetReadDeadline(time.Now().Add(60 * time.Second))
conn.SetWriteDeadline(time.Now().Add(10 * time.Second))
```
**预计时间**: 1天
**验收标准**:
- [ ] WebSocket连接有超时控制
- [ ] 心跳机制正常工作
- [ ] 异常连接能自动清理

---

## 📋 下周任务 (优先级排序)

### 4. 实现会话警告发送界面
**任务**: 完善实时会话监控的管理功能
**位置**: `frontend/src/components/audit/`
**需要创建**:
```typescript
frontend/src/components/audit/SessionWarningModal.tsx
- 警告消息编辑框
- 警告级别选择 (info/warning/error)  
- 发送警告按钮和确认
- 警告历史记录查看
```
**后端API**: 已完成 (`POST /audit/sessions/{id}/warning`)
**预计时间**: 1-2天

### 5. 统一错误处理机制
**任务**: 建立标准化错误码和消息体系
**涉及文件**: 
- `backend/utils/error_codes.go` (新建)
- `backend/utils/http.go` (修改)
- 所有Controller文件 (统一错误返回)
**主要工作**:
```go
// 定义错误码常量
const (
    ErrCodeUserNotFound = "E1001"
    ErrCodeInvalidCredentials = "E1002" 
    ErrCodeAssetNotFound = "E2001"
    // ...
)
```
**预计时间**: 2-3天

### 6. 添加基础单元测试
**任务**: 为核心服务添加单元测试
**优先测试文件**:
```bash
backend/tests/services/
├── connectivity_service_test.go  # 连接服务测试
├── audit_service_test.go         # 审计服务测试  
└── websocket_service_test.go     # WebSocket服务测试
```
**测试覆盖目标**: 核心服务方法覆盖率≥60%
**预计时间**: 3-4天

---

## 🔄 两周内任务

### 7. 会话录制存储机制
**任务**: 扩展SSH服务录制功能
**位置**: `backend/services/ssh_service.go`
**需要实现**:
- SSH会话操作录制到文件
- 录制文件存储路径管理
- 录制文件索引和元数据
- 定期清理过期录制文件
**预计时间**: 4-5天

### 8. 会话回放播放器
**任务**: 创建Linux会话回放组件
**位置**: `frontend/src/components/audit/`
**需要创建**:
```typescript
SessionPlayer.tsx
- 基于xterm.js的回放播放器
- 播放控制 (播放/暂停/快进/后退)
- 时间轴拖拽导航
- 命令高亮和搜索
```
**依赖**: 会话录制存储机制完成
**预计时间**: 5-6天

### 9. IP地理位置服务
**任务**: 实现IP地址地理位置解析
**需要创建**:
```go
backend/services/geolocation_service.go
- IP地址地理位置查询
- 地理位置数据缓存
- 异常地理位置检测算法
```
**前端集成**:
```typescript
frontend/src/components/audit/SessionLocationMap.tsx
- 会话地理位置地图显示
- 异常位置标识
```
**预计时间**: 3-4天

---

## 📊 月度任务

### 10. 邮件告警系统
**任务**: 实现自动化安全告警通知
**主要组件**:
- 后端告警规则引擎
- SMTP邮件发送服务  
- 告警模板管理
- 前端告警规则配置界面
**预计时间**: 1-2周

### 11. 高级统计分析
**任务**: 提供深度数据分析功能
**主要功能**:
- 用户行为分析算法
- 操作热力图生成
- 会话时长分布统计
- 安全风险评估模型
**预计时间**: 1-2周

### 12. 性能优化和监控
**任务**: 系统性能调优和监控建设
**主要工作**:
- 数据库查询优化
- Redis缓存策略改进
- 前端性能优化 (懒加载、虚拟滚动)
- APM监控集成
**预计时间**: 1-2周

---

## 🛠️ 开发环境配置

### 必要的开发工具
```bash
# 后端开发
go version # 需要 Go 1.21+
golangci-lint --version # 代码检查工具

# 前端开发  
node --version # 需要 Node.js 18+
npm --version  # 包管理器

# 数据库
mysql --version # MySQL 8.0
redis-cli --version # Redis 6.0+

# 容器化
docker --version
docker-compose --version
```

### 本地启动命令
```bash
# 启动所有服务
./manage.sh start

# 查看服务状态  
./manage.sh status

# 查看日志
./manage.sh logs [service]

# 重启服务
./manage.sh restart
```

### 开发模式
```bash
# 前端开发模式
cd frontend && npm run dev

# 后端开发模式 (热重载)
cd backend && air # 或 go run main.go
```

---

## 📋 任务执行检查清单

### 开始新任务前
- [ ] 确认当前分支干净 (`git status`)
- [ ] 拉取最新代码 (`git pull origin main`)
- [ ] 检查服务运行正常 (`./manage.sh status`)
- [ ] 阅读相关技术文档

### 任务开发过程中
- [ ] 遵循代码规范和注释标准
- [ ] 定期提交代码 (功能点完成即提交)
- [ ] 运行相关测试确保功能正常
- [ ] 更新API文档 (如有API变更)

### 任务完成后
- [ ] 功能自测通过
- [ ] 代码审查 (如有团队成员)
- [ ] 更新相关文档
- [ ] 标记任务完成状态

---

## ⚠️ 重要提醒

### 安全注意事项
- SSH连接安全配置修复为最高优先级
- 所有新增功能需要考虑安全性
- 敏感信息不得在日志中暴露
- 所有外部输入需要验证和清理

### 代码质量要求
- 新增代码必须有适当的错误处理
- 重要功能需要添加单元测试
- 遵循现有的架构模式和命名规范
- 保持代码注释的完整性

### 开发协作
- 重要修改前先讨论技术方案
- 定期同步开发进度
- 遇到阻塞问题及时沟通
- 保持文档和代码的同步更新

---

**下次开发建议**: 优先解决安全漏洞，然后完善登录日志界面，最后添加WebSocket超时控制。这样可以确保系统安全性，同时推进审计功能的完善。