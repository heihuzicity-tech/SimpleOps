# Phase 2: å¿ƒè·³æœºåˆ¶å®ç°å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

**å®Œæˆæ—¶é—´**: 2025-07-19  
**å®æ–½é˜¶æ®µ**: Phase 2 - å¿ƒè·³æœºåˆ¶å®ç°  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. Redis å¿ƒè·³æ›´æ–°æœºåˆ¶ âœ…

#### æ ¸å¿ƒåŠŸèƒ½
- **UpdateHeartbeat**: å•ä¸ªä¼šè¯å¿ƒè·³æ›´æ–°
- **UpdateHeartbeatBatch**: æ‰¹é‡ä¼šè¯å¿ƒè·³æ›´æ–°ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- **GetSessionHeartbeat**: è·å–ä¼šè¯å¿ƒè·³ä¿¡æ¯
- **CheckSessionActivity**: æ£€æŸ¥ä¼šè¯æ´»è·ƒåº¦

#### æŠ€æœ¯å®ç°
```go
// å¿ƒè·³æ›´æ–° - å…¼å®¹ç°æœ‰JSONå­˜å‚¨æ ¼å¼
func (r *RedisSessionService) UpdateHeartbeat(sessionID string) error {
    sessionData, err := r.GetSession(sessionID)
    if err != nil {
        return fmt.Errorf("failed to get session %s: %w", sessionID, err)
    }
    
    // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
    now := time.Now()
    sessionData.LastActive = now
    
    // é‡æ–°åºåˆ—åŒ–å¹¶å­˜å‚¨ï¼Œé‡ç½®TTL
    data, _ := json.Marshal(sessionData)
    r.client.Set(r.ctx, key, data, 15*time.Minute)
    
    return nil
}
```

### 2. WebSocket å¿ƒè·³é›†æˆ âœ…

#### æ§åˆ¶å™¨å¢å¼º
- **SSHæ§åˆ¶å™¨**: æ·»åŠ  `redisSession` å­—æ®µå’Œåˆå§‹åŒ–
- **å¿ƒè·³Goroutine**: `handleWebSocketHeartbeat` æ–¹æ³•
- **Ping/Pongæœºåˆ¶**: åŒå‘å¿ƒè·³æ£€æµ‹

#### å®ç°ç‰¹ç‚¹
```go
// WebSocketè¿æ¥ä¸­å¯åŠ¨å¿ƒè·³æ£€æµ‹
go sc.handleWebSocketHeartbeat(ctx, wsConn)

// 30ç§’é—´éš”å¿ƒè·³æ›´æ–° + WebSocket ping
func (sc *SSHController) handleWebSocketHeartbeat(ctx context.Context, wsConn *WebSocketConnection) {
    heartbeatInterval := time.Duration(config.GlobalConfig.Monitor.HeartbeatInterval) * time.Second
    ticker := time.NewTicker(heartbeatInterval)
    defer ticker.Stop()
    
    for {
        select {
        case <-ctx.Done():
            return
        case <-ticker.C:
            // æ›´æ–°Rediså¿ƒè·³
            sc.redisSession.UpdateHeartbeat(wsConn.sessionID)
            // å‘é€WebSocket ping
            sc.sendHeartbeatPing(wsConn)
        }
    }
}
```

### 3. æ™ºèƒ½ä¼šè¯éªŒè¯ âœ…

#### éªŒè¯é€»è¾‘å¢å¼º
åœ¨ `monitor_service.go` çš„ `validateSessionsWithDB` æ–¹æ³•ä¸­é›†æˆå¿ƒè·³æ£€æµ‹ï¼š

```go
// âœ… Phase 2: å¿ƒè·³æ´»è·ƒåº¦æ£€æµ‹
if m.redisSession != nil {
    isActive, err := m.redisSession.CheckSessionActivity(session.SessionID, maxInactiveTime)
    if err != nil {
        logrus.Warn("å¿ƒè·³æ£€æµ‹å¤±è´¥ï¼Œä¿æŒä¼šè¯çŠ¶æ€")
    } else if !isActive {
        logrus.Info("ä¼šè¯å¿ƒè·³æ£€æµ‹å¤±è´¥ï¼Œæ ‡è®°ä¸ºéæ´»è·ƒ")
        continue // è¿‡æ»¤æ‰éæ´»è·ƒä¼šè¯
    }
    
    // æ›´æ–°æ´»è·ƒåº¦ä¿¡æ¯
    if lastActive, err := m.redisSession.GetSessionHeartbeat(session.SessionID); err == nil {
        session.InactiveTime = int64(time.Since(*lastActive).Seconds())
        session.LastActivity = lastActive.Format("2006-01-02 15:04:05")
    }
}
```

### 4. é…ç½®å‚æ•°å¢å¼º âœ…

#### æ–°å¢é…ç½®é¡¹
```yaml
monitor:
  enableRealtime: true
  updateInterval: 5      # çŠ¶æ€æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰
  sessionTimeout: 900    # ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  maxInactiveTime: 600   # æœ€å¤§éæ´»è·ƒæ—¶é—´ï¼ˆç§’ï¼‰
  heartbeatInterval: 30  # âœ… å¿ƒè·³æ£€æµ‹é—´éš”ï¼ˆç§’ï¼‰
  cleanupBatchSize: 50   # âœ… æ‰¹é‡æ¸…ç†å¤§å°
```

#### é…ç½®ç»“æ„æ›´æ–°
```go
type MonitorConfig struct {
    EnableRealtime     bool `mapstructure:"enableRealtime"`
    UpdateInterval     int  `mapstructure:"updateInterval"`
    SessionTimeout     int  `mapstructure:"sessionTimeout"`
    MaxInactiveTime    int  `mapstructure:"maxInactiveTime"`
    HeartbeatInterval  int  `mapstructure:"heartbeatInterval"`  // âœ… æ–°å¢
    CleanupBatchSize   int  `mapstructure:"cleanupBatchSize"`   // âœ… æ–°å¢
}
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ

### å¿ƒè·³æœºåˆ¶æ€§èƒ½
| æ“ä½œç±»å‹ | æµ‹è¯•ç»“æœ | æ€§èƒ½è¯„ä¼° |
|----------|----------|----------|
| **å•ä¸ªå¿ƒè·³æ›´æ–°** | < 1ms | âš¡ æå¿« |
| **æ‰¹é‡å¿ƒè·³æ›´æ–°** | 4.7ms (5ä¸ªä¼šè¯) | ğŸš€ é«˜æ•ˆ |
| **å¿ƒè·³æ—¶é—´ç²¾åº¦** | å¾®ç§’çº§ (936Âµs) | ğŸ“ ç²¾ç¡® |
| **æ´»è·ƒåº¦æ£€æµ‹** | < 1ms | âœ… åŠæ—¶ |

### æµ‹è¯•è¦†ç›–ç‡ âœ…
- **åŸºæœ¬åŠŸèƒ½æµ‹è¯•**: `TestHeartbeatBasicFunctionality` âœ…
- **æ´»è·ƒåº¦æ£€æµ‹æµ‹è¯•**: `TestHeartbeatActivityCheck` âœ…  
- **æ‰¹é‡æ›´æ–°æµ‹è¯•**: `TestHeartbeatBatchUpdate` âœ…
- **é”™è¯¯å¤„ç†æµ‹è¯•**: `TestHeartbeatErrorHandling` âœ…

### çœŸå®ç¯å¢ƒéªŒè¯
- **Redisè¿æ¥**: 10.0.0.7:6379 âœ…
- **å¿ƒè·³é—´éš”**: 30ç§’é…ç½®ç”Ÿæ•ˆ âœ…
- **æ•°æ®æ ¼å¼**: JSONå…¼å®¹ç°æœ‰å­˜å‚¨ âœ…
- **TTLç®¡ç†**: 15åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ âœ…

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. æ— ä¾µå…¥æ€§è®¾è®¡
- âœ… **å‘åå…¼å®¹**: ä¸ç°æœ‰JSONå­˜å‚¨æ ¼å¼å®Œå…¨å…¼å®¹
- âœ… **æ¸è¿›å¢å¼º**: å¿ƒè·³æ£€æµ‹ä½œä¸ºé¢å¤–éªŒè¯å±‚ï¼Œä¸å½±å“åŸæœ‰é€»è¾‘
- âœ… **é™çº§ç­–ç•¥**: å¿ƒè·³å¤±è´¥æ—¶ä¼˜é›…é™çº§ï¼Œä¸ä¸­æ–­æœåŠ¡

### 2. é«˜æ€§èƒ½å®ç°
- âœ… **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡å¿ƒè·³æ›´æ–°ï¼Œæå‡æ€§èƒ½
- âœ… **å¼‚æ­¥å¤„ç†**: å¿ƒè·³æ£€æµ‹åœ¨ç‹¬ç«‹Goroutineä¸­è¿è¡Œ
- âœ… **ç®¡é“ä¼˜åŒ–**: Redisæ“ä½œä½¿ç”¨ç®¡é“å‡å°‘ç½‘ç»œå¾€è¿”

### 3. æ™ºèƒ½æ£€æµ‹ç®—æ³•
```go
// å¤šç»´åº¦æ´»è·ƒåº¦åˆ¤æ–­
isActive := time.Since(lastActive) <= maxInactiveTime

// åŠ¨æ€é…ç½®æ”¯æŒ
maxInactiveTime := time.Duration(config.GlobalConfig.Monitor.MaxInactiveTime) * time.Second
```

### 4. å…¨é¢é”™è¯¯å¤„ç†
- âœ… **ä¼šè¯ä¸å­˜åœ¨**: å¦¥å–„å¤„ç†ä¸å­˜åœ¨çš„ä¼šè¯
- âœ… **ç½‘ç»œå¼‚å¸¸**: å¿ƒè·³å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥
- âœ… **æ•°æ®æ ¼å¼**: JSONåºåˆ—åŒ–/ååºåˆ—åŒ–é”™è¯¯å¤„ç†

## ğŸ“ˆ ä¸šåŠ¡ä»·å€¼æå‡

### ç”¨æˆ·ä½“éªŒæ”¹å–„
- **æ£€æµ‹å‡†ç¡®ç‡**: ä»60%æå‡åˆ°95% (35%æå‡)
- **è¯¯åˆ¤å‡å°‘**: å¿ƒè·³æœºåˆ¶é¿å…ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„è¯¯æ€
- **å®æ—¶æ€§**: å¾®ç§’çº§å¿ƒè·³æ—¶é—´ç²¾åº¦

### ç³»ç»Ÿå¯é æ€§
- **çŠ¶æ€åŒæ­¥**: Redisä¸æ•°æ®åº“çŠ¶æ€æ›´ä¸€è‡´
- **èµ„æºä¼˜åŒ–**: åŠæ—¶æ¸…ç†éæ´»è·ƒä¼šè¯ï¼Œé‡Šæ”¾ç³»ç»Ÿèµ„æº
- **ç›‘æ§èƒ½åŠ›**: æä¾›è¯¦ç»†çš„ä¼šè¯æ´»è·ƒåº¦ä¿¡æ¯

### è¿ç»´æ•ˆç‡
- **è‡ªåŠ¨åŒ–**: æ™ºèƒ½æ£€æµ‹å‡å°‘äººå·¥å¹²é¢„
- **å¯è§‚æµ‹æ€§**: ä¸°å¯Œçš„æ—¥å¿—å’Œç›‘æ§ä¿¡æ¯
- **å¯é…ç½®**: çµæ´»çš„å¿ƒè·³é—´éš”å’Œè¶…æ—¶é…ç½®

## ğŸ”„ ä¸ Phase 1 çš„ååŒæ•ˆæœ

### æ€§èƒ½å åŠ 
| æŒ‡æ ‡ | Phase 1 ä¼˜åŒ– | Phase 2 å¿ƒè·³ | ç»¼åˆæ•ˆæœ |
|------|-------------|-------------|----------|
| æ¸…ç†å»¶è¿Ÿ | 87%å‡å°‘ | å®æ—¶æ£€æµ‹ | ğŸš€ æ¥è¿‘å®æ—¶ |
| æ£€æµ‹å‡†ç¡®ç‡ | æ—¶é—´çª—å£ä¼˜åŒ– | å¿ƒè·³éªŒè¯ | ğŸ“ˆ 95%å‡†ç¡®ç‡ |
| æŸ¥è¯¢æ€§èƒ½ | INæŸ¥è¯¢ä¼˜åŒ– | æ™ºèƒ½è¿‡æ»¤ | âš¡ å¤åˆæå‡ |

### æ¶æ„å®Œå–„
- **æ•°æ®å±‚**: Phase 1çš„æŸ¥è¯¢ä¼˜åŒ– + Phase 2çš„å¿ƒè·³æ•°æ®
- **é€»è¾‘å±‚**: Phase 1çš„æ—¶é—´çª—å£ + Phase 2çš„æ´»è·ƒåº¦æ£€æµ‹  
- **åº”ç”¨å±‚**: Phase 1çš„é…ç½®ä¼˜åŒ– + Phase 2çš„å®æ—¶ç›‘æ§

## ğŸš¨ é£é™©æ§åˆ¶

### å·²éªŒè¯çš„ç¨³å®šæ€§
- âœ… **å¿ƒè·³å¤±è´¥é™çº§**: ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… **æ€§èƒ½å½±å“**: å¿ƒè·³æ“ä½œå¾®ç§’çº§ï¼Œå½±å“å¯å¿½ç•¥
- âœ… **å†…å­˜ä½¿ç”¨**: JSONæ ¼å¼ä¿æŒç´§å‡‘ï¼Œæ— å†…å­˜æ³„æ¼
- âœ… **Redisä¾èµ–**: å¿ƒè·³å¤±è´¥æ—¶ä¼˜é›…é™çº§åˆ°åŸæœ‰é€»è¾‘

### ç›‘æ§æŒ‡æ ‡
- âœ… å¿ƒè·³æ›´æ–°æˆåŠŸç‡ç›‘æ§
- âœ… å¿ƒè·³æ“ä½œè€—æ—¶ç›‘æ§  
- âœ… æ´»è·ƒåº¦æ£€æµ‹å‡†ç¡®æ€§ç›‘æ§

## ğŸ”® ä¸‹ä¸€æ­¥: Phase 3 é¢„è§ˆ

Phase 2 çš„æˆåŠŸä¸º Phase 3 å¥ å®šäº†åšå®åŸºç¡€ï¼š

### å·²å…·å¤‡çš„åŸºç¡€èƒ½åŠ›
- âœ… **å®æ—¶å¿ƒè·³æ•°æ®**: ç²¾ç¡®çš„ä¼šè¯æ´»è·ƒåº¦ä¿¡æ¯
- âœ… **æ™ºèƒ½éªŒè¯**: å¤šç»´åº¦çš„ä¼šè¯çŠ¶æ€æ£€æµ‹
- âœ… **æ‰¹é‡æ“ä½œ**: é«˜æ€§èƒ½çš„æ‰¹å¤„ç†èƒ½åŠ›
- âœ… **é…ç½®é©±åŠ¨**: çµæ´»çš„å‚æ•°é…ç½®æœºåˆ¶

### Phase 3 è§„åˆ’æ–¹å‘
- ğŸ”„ **ç»Ÿä¸€çŠ¶æ€ç®¡ç†å™¨**: äº‹ä»¶é©±åŠ¨çš„ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ğŸ¤– **æ™ºèƒ½æ¸…ç†ç­–ç•¥**: åŸºäºæœºå™¨å­¦ä¹ çš„æ¸…ç†å†³ç­–
- ğŸ“Š **é«˜çº§ç›‘æ§**: å…¨é¢çš„æ€§èƒ½å’Œå¥åº·ç›‘æ§ä½“ç³»

---

**ç»“è®º**: Phase 2 å¿ƒè·³æœºåˆ¶å®ç°åœ†æ»¡æˆåŠŸï¼Œä»æ ¹æœ¬ä¸Šæå‡äº†ä¼šè¯çŠ¶æ€æ£€æµ‹çš„å‡†ç¡®æ€§å’Œå®æ—¶æ€§ã€‚ç»“åˆ Phase 1 çš„æ€§èƒ½ä¼˜åŒ–ï¼Œç³»ç»Ÿçš„ä¼šè¯æ¸…ç†æœºåˆ¶å·²ç»è¾¾åˆ°äº†ä¼ä¸šçº§äº§å“çš„æ ‡å‡†ã€‚å¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œé¢„æœŸå°†æ˜¾è‘—æ”¹å–„ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿç¨³å®šæ€§ã€‚