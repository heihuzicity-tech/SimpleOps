# 会话管理重构开发计划

## 背景
当前系统中会话管理和资产管理功能存在重叠，需要重构以明确职责分离。

## 开发目标
1. 将资产管理的SSH测试逻辑移植到会话管理
2. 创建独立的SSH终端连接页面
3. 修复会话连接功能
4. 优化用户体验

## 具体开发任务

### 一、核心功能修复和迁移

#### 1. 将SSH测试逻辑移植到会话管理
- **文件**: `pages/sessions/HostSessionsPage.tsx`
- **任务**:
  - 从 `AssetsPage` 中提取 `performLayeredConnectionTest` 逻辑
  - 在会话管理页面实现连接前的可用性测试
  - 保留分层测试策略（ping → SSH服务测试）
  - 显示测试结果（延迟、连接状态）

#### 2. 创建独立的SSH终端连接页面
- **路径**: `/connect/terminal/:sessionId`
- **文件**: `pages/connect/TerminalPage.tsx`
- **功能**:
  - 顶部状态栏：显示连接信息、用户、主机
  - 终端主体：使用现有的 `WebTerminal` 组件
  - 底部工具栏：断开连接、全屏切换
  - 全屏终端界面

#### 3. 修复会话连接功能
- **涉及文件**:
  - `services/sshAPI.ts`
  - `store/sshSessionSlice.ts`
  - `components/ssh/WebTerminal.tsx`
- **任务**:
  - 检查 `sshAPI.createSession` 的调用流程
  - 确保凭证选择机制正常工作
  - 修复 WebSocket 连接 URL 配置
  - 验证后端 SSH 会话创建接口

### 二、会话管理页面优化

#### 4. 优化连接流程
- **文件**: `pages/sessions/HostSessionsPage.tsx`
- **任务**:
  - 添加凭证选择对话框
  - 实现连接前的测试功能
  - 连接成功后跳转到独立终端页面
  - 保存连接历史

#### 5. 移除冗余功能
- **文件**: `pages/sessions/HostSessionsPage.tsx`
- **任务**:
  - 删除编辑、删除按钮
  - 移除内嵌的终端Modal
  - 简化表格列，突出连接操作

#### 6. 增强筛选和搜索
- **文件**: `pages/sessions/HostSessionsPage.tsx`
- **任务**:
  - 添加系统类型筛选（Linux/Windows）
  - 添加协议筛选（SSH/RDP）
  - 添加连接状态筛选
  - 优化搜索功能

### 三、用户体验优化

#### 7. 最近连接记录
- **文件**: 新建 `hooks/useRecentConnections.ts`
- **功能**:
  - 保存最近连接的主机
  - 支持快速重连
  - 使用 localStorage 持久化

#### 8. 页面路由调整
- **文件**: `App.tsx`
- **调整**:
  - `/sessions/hosts` → `/connect/hosts`
  - 新增 `/connect/terminal/:sessionId`

## 实现代码示例

### 连接测试服务
```typescript
// services/connectionTest.ts
import { message } from 'antd';
import { testConnection } from '../store/assetSlice';

export interface ConnectionTestResult {
  success: boolean;
  latency?: number;
  message: string;
}

export const performConnectionTest = async (
  dispatch: any,
  asset: any,
  credentialId: number
): Promise<ConnectionTestResult> => {
  try {
    // 第一层：主机连通性测试
    const pingResult = await dispatch(testConnection({
      asset_id: asset.id,
      credential_id: credentialId,
      test_type: 'ping'
    })).unwrap();
    
    if (!pingResult.result.success) {
      return {
        success: false,
        message: `主机不可达: ${asset.address}`
      };
    }
    
    // 第二层：服务测试
    if (asset.protocol === 'ssh') {
      const sshResult = await dispatch(testConnection({
        asset_id: asset.id,
        credential_id: credentialId,
        test_type: 'ssh'
      })).unwrap();
      
      return {
        success: sshResult.result.success,
        latency: sshResult.result.latency,
        message: sshResult.result.success 
          ? `SSH服务正常 (延迟: ${sshResult.result.latency}ms)`
          : `SSH服务异常: ${sshResult.result.message}`
      };
    }
    
    return {
      success: true,
      latency: pingResult.result.latency,
      message: `主机连通正常 (延迟: ${pingResult.result.latency}ms)`
    };
  } catch (error: any) {
    return {
      success: false,
      message: `连接测试异常: ${error.message}`
    };
  }
};
```

### 凭证选择对话框
```typescript
// components/sessions/CredentialSelector.tsx
import React from 'react';
import { Modal, Select, Form } from 'antd';

interface CredentialSelectorProps {
  visible: boolean;
  asset: any;
  credentials: any[];
  onSelect: (credentialId: number) => void;
  onCancel: () => void;
}

export const CredentialSelector: React.FC<CredentialSelectorProps> = ({
  visible,
  asset,
  credentials,
  onSelect,
  onCancel
}) => {
  const [form] = Form.useForm();
  
  const handleOk = async () => {
    const values = await form.validateFields();
    onSelect(values.credentialId);
  };
  
  return (
    <Modal
      title={`选择连接凭证 - ${asset.name}`}
      open={visible}
      onOk={handleOk}
      onCancel={onCancel}
    >
      <Form form={form}>
        <Form.Item
          name="credentialId"
          label="连接凭证"
          rules={[{ required: true, message: '请选择凭证' }]}
        >
          <Select placeholder="请选择连接凭证">
            {credentials.map(cred => (
              <Select.Option key={cred.id} value={cred.id}>
                {cred.name} ({cred.username})
              </Select.Option>
            ))}
          </Select>
        </Form.Item>
      </Form>
    </Modal>
  );
};
```

## 预计工时

- **第一阶段**（核心功能）：12-16小时
  - 任务1-3：每个4-6小时
  
- **第二阶段**（优化）：8-10小时
  - 任务4-6：每个2-4小时
  
- **第三阶段**（体验提升）：4-6小时
  - 任务7-8：每个2-3小时

**总计**：24-32小时

## 开发完成情况

### ✅ 已完成功能

1. **连接测试服务** (`services/connectionTest.ts`)
   - 分层测试逻辑（ping -> SSH服务测试）
   - 统一的错误处理和消息提示
   - 支持快速测试和详细测试

2. **凭证选择组件** (`components/sessions/CredentialSelector.tsx`)
   - 智能凭证匹配和优先显示
   - 凭证详情展示
   - 友好的用户界面

3. **独立终端页面** (`pages/connect/TerminalPage.tsx`)
   - 全屏沉浸式终端体验
   - 实时连接状态和时长显示
   - 完整的会话管理功能

4. **会话管理重构** (`pages/sessions/HostSessionsPage.tsx`)
   - 移除资产编辑功能，专注连接
   - 集成连接测试和凭证选择
   - 添加筛选和搜索功能

5. **快速访问功能**
   - Hook: `hooks/useRecentConnections.ts`
   - 组件: `components/sessions/QuickAccess.tsx`
   - 本地存储的连接历史管理

6. **路由重构**
   - 新路由: `/connect/hosts`, `/connect/terminal/:sessionId`
   - 向后兼容的自动重定向
   - 更新导航菜单结构

### 📋 测试清单

详细测试指南请参考: `frontend/test-connection.md`

### 🚀 部署建议

1. **渐进式部署**
   - 先部署到测试环境验证功能
   - 确认WebSocket连接稳定性
   - 验证各种边界情况

2. **用户培训**
   - 新的连接流程与旧版本有差异
   - 建议提供操作指南
   - 重点说明快速访问功能

3. **监控指标**
   - 连接成功率
   - 用户体验满意度
   - 性能表现（加载时间、响应速度）

## 注意事项

1. ✅ 保持向后兼容，旧路由自动重定向
2. ✅ WebSocket连接已优化，支持重连机制
3. ✅ 完善的异常处理（网络断开、会话超时等）
4. ✅ 安全性增强，凭证选择流程更安全
5. ✅ 用户体验优化，减少操作步骤