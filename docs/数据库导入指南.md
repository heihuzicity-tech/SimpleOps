# 数据库导入指南

## 概述

本指南将帮助您完成运维堡垒机系统的数据库初始化和配置。根据您提供的数据库信息，我们已经准备好了自动化导入脚本。

## 数据库信息

- **MySQL服务器**: 10.0.0.51:3306
- **Redis服务器**: 10.0.0.51:6379

## 准备工作

### 1. 检查MySQL客户端

请确保您的系统已安装MySQL客户端：

```bash
# macOS
brew install mysql-client

# Ubuntu/Debian
sudo apt-get install mysql-client-core-8.0

# CentOS/RHEL
sudo yum install mysql
```

### 2. 配置数据库连接

编辑配置文件 `backend/config/config.yaml`，将MySQL密码替换为实际密码：

```yaml
database:
  host: "10.0.0.51"
  port: 3306
  username: "root"
  password: "your_mysql_password_here"  # 请替换为实际密码
  dbname: "bastion"
```

## 数据库导入方法

### 方法一：使用自动化脚本（推荐）

我们提供了一个自动化导入脚本，可以自动完成数据库创建和数据导入：

```bash
# 进入项目目录
cd /Users/skip/workspace/bastion

# 使用默认配置执行导入脚本
./scripts/import_database.sh

# 或者指定具体参数
./scripts/import_database.sh 10.0.0.51 3306 root your_password bastion
```

**脚本参数说明：**
- 参数1: MySQL主机地址（默认: 10.0.0.51）
- 参数2: MySQL端口（默认: 3306）
- 参数3: MySQL用户名（默认: root）
- 参数4: MySQL密码（默认: 空，会提示输入）
- 参数5: 数据库名称（默认: bastion）

### 方法二：手动导入

如果您需要手动导入，可以按照以下步骤操作：

1. **连接到MySQL服务器**
```bash
mysql -h 10.0.0.51 -P 3306 -u root -p
```

2. **创建数据库**
```sql
CREATE DATABASE IF NOT EXISTS bastion CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE bastion;
```

3. **导入SQL文件**
```bash
mysql -h 10.0.0.51 -P 3306 -u root -p bastion < scripts/init.sql
```

## 导入内容说明

### 数据库表结构

导入脚本将创建以下7个核心表：

1. **users** - 用户表
2. **roles** - 角色表
3. **user_roles** - 用户角色关联表
4. **assets** - 资产表
5. **credentials** - 凭证表
6. **sessions** - 会话记录表
7. **operation_logs** - 操作日志表

### 初始数据

导入完成后，系统会自动创建以下初始数据：

#### 默认角色
- **admin** - 系统管理员（拥有所有权限）
- **operator** - 运维人员（资产访问权限）
- **auditor** - 审计员（审计查看权限）

#### 默认管理员账户
- **用户名**: admin
- **密码**: admin123
- **角色**: 系统管理员

#### 示例资产数据
- 开发服务器-01 (192.168.1.10:22)
- 生产数据库-01 (192.168.1.20:3306)

## 验证导入结果

### 1. 检查数据库表

```bash
mysql -h 10.0.0.51 -P 3306 -u root -p bastion -e "SHOW TABLES;"
```

预期输出应该包含7个表：
```
+-------------------+
| Tables_in_bastion |
+-------------------+
| assets            |
| credentials       |
| operation_logs    |
| roles             |
| sessions          |
| user_roles        |
| users             |
+-------------------+
```

### 2. 验证默认用户

```bash
mysql -h 10.0.0.51 -P 3306 -u root -p bastion -e "SELECT username, email, status FROM users;"
```

### 3. 测试Redis连接

```bash
redis-cli -h 10.0.0.51 -p 6379 ping
```

预期输出：`PONG`

## 常见问题解决

### Q1: 连接被拒绝
**问题**: ERROR 2003 (HY000): Can't connect to MySQL server

**解决方案**:
1. 检查MySQL服务是否运行
2. 确认防火墙设置允许3306端口
3. 验证MySQL配置允许远程连接

### Q2: 权限不足
**问题**: ERROR 1045 (28000): Access denied for user

**解决方案**:
1. 确认用户名和密码正确
2. 检查MySQL用户是否有CREATE DATABASE权限
3. 如需要，在MySQL中执行：
   ```sql
   GRANT ALL PRIVILEGES ON bastion.* TO 'root'@'%';
   FLUSH PRIVILEGES;
   ```

### Q3: 数据库已存在
**问题**: 数据库bastion已存在

**解决方案**:
- 脚本会自动检测并继续使用现有数据库
- 如需重新创建，请先删除现有数据库：
  ```sql
  DROP DATABASE IF EXISTS bastion;
  ```

## 下一步

数据库导入完成后，您可以：

1. **启动后端服务**：进入backend目录开始开发用户认证系统
2. **配置前端**：配置React前端项目连接到后端API
3. **测试功能**：使用默认管理员账户测试登录功能

## 技术支持

如果在导入过程中遇到问题，请检查：
1. 网络连接是否正常
2. MySQL服务状态
3. 权限配置是否正确
4. SQL文件内容是否完整

确保所有配置正确后，即可开始下一阶段的开发工作。 