# 前端开发指南

## 概述

运维堡垒机前端系统基于React 18 + TypeScript构建，采用现代化的前端技术栈，提供企业级的用户界面和用户体验。

## 技术栈

### 核心技术
- **React 18**: 现代化的前端框架
- **TypeScript**: 类型安全的JavaScript
- **Ant Design 5**: 企业级UI组件库
- **Redux Toolkit**: 状态管理
- **React Router v6**: 现代化的路由系统
- **Axios**: HTTP客户端
- **xterm.js**: 终端模拟器
- **WebSocket**: 实时双向通信

### 开发工具
- **Create React App**: React应用脚手架和构建工具
- **ESLint**: 代码规范检查
- **Prettier**: 代码格式化
- **Jest**: 单元测试框架

## 项目结构

```
frontend/
├── public/                 # 静态资源
│   └── index.html         # HTML模板
├── src/
│   ├── components/         # 通用组件
│   │   ├── DashboardLayout.tsx   # 主布局组件
│   │   └── PermissionGuard.tsx   # 权限守卫组件
│   ├── pages/              # 页面组件
│   │   ├── LoginPage.tsx         # 登录页面 ✅
│   │   ├── UsersPage.tsx         # 用户管理页面 ✅
│   │   ├── AssetsPage.tsx        # 资产管理页面 ✅
│   │   ├── CredentialsPage.tsx   # 凭证管理页面 ✅
│   │   ├── AuditLogsPage.tsx     # 审计日志页面 ⏳
│   │   └── SSHSessionsPage.tsx   # SSH会话页面 ✅
│   ├── services/           # API服务
│   │   ├── apiClient.ts          # HTTP客户端配置
│   │   ├── authAPI.ts            # 认证API
│   │   ├── userAPI.ts            # 用户API
│   │   ├── assetAPI.ts           # 资产API
│   │   ├── credentialAPI.ts      # 凭证API
│   │   └── sshAPI.ts             # SSH会话API
│   ├── store/              # Redux状态管理
│   │   ├── index.ts              # Store配置
│   │   ├── authSlice.ts          # 认证状态
│   │   ├── userSlice.ts          # 用户状态
│   │   ├── assetSlice.ts         # 资产状态
│   │   ├── credentialSlice.ts    # 凭证状态
│   │   └── sshSessionSlice.ts    # SSH会话状态
│   ├── utils/              # 工具函数
│   │   └── permissions.ts        # 权限工具函数
│   ├── App.tsx             # 应用主组件
│   ├── index.tsx           # 应用入口
│   └── index.css           # 全局样式
├── package.json            # 依赖管理
└── tsconfig.json           # TypeScript配置
```

## 已完成功能

### 1. 用户认证系统 ✅
- **登录界面**: 响应式登录表单，支持用户名/密码认证
- **JWT认证**: 自动Token管理和刷新
- **登录状态**: 登录状态持久化和自动恢复
- **退出登录**: 安全的登出流程

### 2. 布局系统 ✅
- **响应式布局**: 适配不同屏幕尺寸的管理后台布局
- **导航菜单**: 侧边栏导航菜单，支持图标和路由
- **头部导航**: 用户信息、退出登录等功能
- **面包屑导航**: 自动生成的面包屑导航

### 3. 用户管理 ✅
- **用户列表**: 分页显示用户列表，支持搜索和筛选
- **用户创建**: 表单验证的用户创建功能
- **用户编辑**: 行内编辑和弹框编辑支持
- **用户删除**: 软删除功能
- **状态管理**: 用户状态切换（启用/禁用）

### 4. 资产管理 ✅
- **资产列表**: 分页显示资产列表
- **资产创建**: 支持多种资产类型的创建
- **资产编辑**: 完整的资产信息编辑
- **资产删除**: 软删除功能
- **连接测试**: 资产连接状态测试

### 5. 权限系统 ✅
- **基于角色的访问控制**: 完整的RBAC权限系统
- **动态菜单**: 根据用户角色动态显示菜单项
- **页面保护**: PermissionGuard组件保护需要特定权限的页面
- **权限工具**: 统一的权限检查工具函数
- **友好提示**: 403权限不足页面，引导用户返回

#### 5.1 权限检查工具函数
```typescript
// utils/permissions.ts
export const hasAdminPermission = (user: User | null): boolean => {
  if (!user || !user.roles) return false;
  return user.roles.some(role => role.name === 'admin');
};

export const hasOperatorPermission = (user: User | null): boolean => {
  if (!user || !user.roles) return false;
  return user.roles.some(role => 
    role.name === 'admin' || role.name === 'operator'
  );
};

export const hasAnyRole = (user: User | null, roleNames: string[]): boolean => {
  if (!user || !user.roles) return false;
  return roleNames.some(roleName => 
    user.roles.some(role => role.name === roleName)
  );
};
```

#### 5.2 页面权限保护
```typescript
// 在App.tsx中使用PermissionGuard保护路由
<Route 
  path="/users" 
  element={
    <PermissionGuard requiredRole="admin">
      <UsersPage />
    </PermissionGuard>
  } 
/>

<Route 
  path="/assets" 
  element={
    <PermissionGuard requiredRole={['admin', 'operator']}>
      <AssetsPage />
    </PermissionGuard>
  } 
/>
```

#### 5.3 动态菜单控制
```typescript
// 在DashboardLayout中根据权限动态生成菜单
const getMenuItems = () => {
  const items = [{ key: '/dashboard', icon: <DashboardOutlined />, label: '仪表板' }];
  
  // 管理员功能
  if (hasAdminPermission(user)) {
    items.push({ key: '/users', icon: <UserOutlined />, label: '用户管理' });
  }
  
  // 运维人员和管理员功能
  if (hasOperatorPermission(user)) {
    items.push(
      { key: '/assets', icon: <DesktopOutlined />, label: '资产管理' },
      { key: '/ssh-sessions', icon: <ConsoleSqlOutlined />, label: 'SSH会话' }
    );
  }
  
  return items;
};
```

## 数据流架构

### API集成
```typescript
// API服务层
export const authAPI = {
  login: (credentials: LoginCredentials) => request.post('/auth/login', credentials),
  logout: () => request.post('/logout'),
  getProfile: () => request.get('/profile'),
  changePassword: (data: ChangePasswordData) => request.post('/change-password', data)
};

// Redux Slice
export const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    // 同步actions
  },
  extraReducers: (builder) => {
    builder
      .addCase(loginAsync.fulfilled, (state, action) => {
        state.isAuthenticated = true;
        state.user = action.payload.user;
        state.token = action.payload.token;
      })
      // 其他异步actions
  }
});
```

### 状态管理
- **认证状态**: 用户登录状态、用户信息、Token管理
- **用户状态**: 用户列表、角色列表、权限信息
- **资产状态**: 资产列表、凭证信息、连接状态
- **UI状态**: 加载状态、错误信息、表单状态

## 常见问题解决方案

### 1. React Router升级问题
**问题**: React Router v6废弃警告
**解决方案**: 添加future flags配置
```typescript
// App.tsx
<BrowserRouter future={{ v7_relativeSplatPath: true, v7_startTransition: true }}>
  <Routes>
    <Route path="/*" element={<AppRoutes />} />
  </Routes>
</BrowserRouter>
```

### 2. 前后端数据格式不一致
**问题**: 后端返回`{success: true, data: {...}}`格式，前端期望直接的数据
**解决方案**: 在API响应处理中统一数据格式
```typescript
// userSlice.ts
.addCase(fetchUsers.fulfilled, (state, action) => {
  // 处理后端返回的嵌套数据格式
  if (action.payload.success && action.payload.data) {
    state.users = action.payload.data.users || [];
    state.roles = action.payload.data.roles || [];
  }
})
```

### 3. 用户状态数据类型不匹配
**问题**: 前端发送字符串状态，后端期望数字状态
**解决方案**: 在提交前进行数据转换
```typescript
// 提交时转换状态格式
const submitData = {
  ...values,
  status: values.status === 'active' ? 1 : 0
};
```

### 4. 图标导入错误
**问题**: 导入不存在的Ant Design图标
**解决方案**: 使用正确的图标名称
```typescript
// 错误
import { TerminalOutlined } from '@ant-design/icons';

// 正确
import { ConsoleSqlOutlined } from '@ant-design/icons';
```

### 5. API端点路径问题
**问题**: 前端API路径与后端不一致
**解决方案**: 统一API路径配置
```typescript
// authAPI.ts
export const authAPI = {
  login: (credentials: LoginCredentials) => request.post('/auth/login', credentials),
  logout: () => request.post('/logout'),  // 注意：不是/auth/logout
  getProfile: () => request.get('/profile'),  // 注意：不是/auth/profile
  changePassword: (data: ChangePasswordData) => request.post('/change-password', data)
};
```

## 开发中功能

### 1. SSH终端界面 🚧
- **WebSSH终端**: 基于xterm.js的终端界面
- **会话管理**: SSH会话列表和管理
- **实时连接**: WebSocket实时通信
- **终端配置**: 终端主题、字体、大小配置

### 2. 审计日志界面 🚧
- **日志查看**: 各类审计日志的查看界面
- **日志筛选**: 按时间、用户、操作类型筛选
- **日志导出**: 审计日志导出功能
- **统计报表**: 审计数据统计和图表展示

### 3. 权限控制系统 🚧
- **路由权限**: 基于角色的路由访问控制
- **组件权限**: 组件级别的权限控制
- **按钮权限**: 按钮级别的权限控制
- **数据权限**: 数据级别的权限控制

## 开发指南

### 1. 环境配置
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 运行测试
npm run test
```

### 2. 添加新页面
1. 在`src/pages/`目录创建新的页面组件
2. 在`src/services/`目录添加相应的API服务
3. 在`src/store/`目录添加状态管理slice
4. 在`src/types/`目录添加TypeScript类型定义
5. 在路由配置中添加新路由

### 3. 调试技巧
- 使用Redux DevTools查看状态变化
- 使用React DevTools调试组件
- 使用Network面板调试API请求
- 使用Console查看错误信息

### 4. 代码规范
- 使用TypeScript进行类型检查
- 遵循ESLint代码规范
- 使用Prettier格式化代码
- 编写单元测试

## 部署说明

### 1. 开发环境
```bash
npm run dev
```
访问: http://localhost:3000

### 2. 生产环境
```bash
npm run build
npm run preview
```

### 3. Docker部署
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["npm", "run", "preview"]
```

## 性能优化

### 1. 代码分割
- 使用React.lazy()进行组件懒加载
- 路由级别的代码分割
- 第三方库的按需加载

### 2. 缓存策略
- Redux Toolkit Query API缓存
- 组件级别的缓存
- 静态资源缓存

### 3. 渲染优化
- 使用React.memo()避免不必要的重渲染
- 使用useMemo()和useCallback()优化计算
- 虚拟滚动处理大量数据

## SSH终端模块

### 组件架构

SSH终端模块包含以下核心组件：

#### 1. SSHConnectionModal 
连接配置对话框，用于创建新的SSH会话：
```typescript
interface SSHConnectionModalProps {
  visible: boolean;
  onCancel: () => void;
  onSuccess: (session: SSHSessionResponse) => void;
}
```

#### 2. WebTerminal
终端组件，基于xterm.js实现：
```typescript
interface WebTerminalProps {
  sessionId: string;
  onClose: () => void;
  onError?: (error: Error) => void;
}
```

特性：
- xterm.js终端模拟器集成
- WebSocket双向通信
- 终端大小自适应
- 全屏模式支持
- 连接状态监控和重连

#### 3. SSHSessionsPage
会话管理页面：
- 活跃会话列表
- 会话创建和管理
- 多终端标签页支持

### WebSocket集成

终端通过WebSocket与后端通信：

**连接URL**: `ws://localhost:8080/api/v1/ws/ssh/sessions/{sessionId}/ws?token={jwt}`

**消息类型**:
- `input`: 用户输入数据
- `output`: 服务器输出数据  
- `resize`: 终端大小调整
- `ping/pong`: 心跳检测

### 状态管理

SSH相关状态通过Redux管理：

```typescript
interface SSHSessionState {
  sessions: SSHSessionResponse[];
  activeSessions: Record<string, ConnectionStatus>;
  loading: boolean;
  error: string | null;
}
```

### 技术要点

1. **组件生命周期管理**: 避免内存泄漏，正确清理WebSocket连接
2. **错误处理**: 网络断开重连，权限验证失败处理
3. **性能优化**: 终端输出缓冲，大量数据处理优化

## 未来规划

1. **移动端适配**: 响应式设计的移动端优化
2. **国际化**: 多语言支持
3. **主题系统**: 可配置的主题系统和终端主题
4. **离线支持**: PWA和离线功能
5. ✅ **实时通知**: WebSocket实时通知系统 (已完成) 