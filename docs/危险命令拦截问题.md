  问题分析

  当前的问题是：
  1. 手动输入命令：命令会被正确拦截（因为每个字符都经过 updateCommandBuffer）
  2. 使用历史命令：命令不会被拦截（因为历史命令是服务器直接返回的，不经过输入流）

  技术挑战

  1. SSH 协议的复杂性：
    - 用户按上/下键 → 发送控制序列（如 \x1b[A）
    - SSH 服务器处理并返回历史命令
    - 历史命令通过输出流显示，不经过输入流
  2. 命令获取的困难：
    - 需要从输出流解析当前显示的命令
    - 输出流可能包含各种控制字符、颜色代码等
    - 不同的 shell（bash、zsh 等）可能有不同的行为

  可能的解决方案

  1. 方案一：从输出流解析命令
    - 优点：可以捕获所有显示的命令
    - 缺点：实现复杂，需要处理各种终端控制序列
  2. 方案二：在服务器端拦截
    - 优点：更可靠，可以拦截所有命令
    - 缺点：需要在 SSH 服务器端安装钩子或使用 PTY 包装
  3. 方案三：禁用历史命令功能
    - 优点：简单直接
    - 缺点：影响用户体验

  您倾向于哪种方案？或者您有其他的想法吗？